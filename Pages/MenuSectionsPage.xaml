<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local="clr-namespace:Imdeliceapp.Pages"
             x:Class="Imdeliceapp.Pages.MenuSectionsPage"
             x:Name="Page"
             Title="{Binding Titulo}"
             BackgroundColor="{AppThemeBinding Light=White, Dark=Black}"
             Shell.NavBarIsVisible="True"
             Shell.BackgroundColor="{StaticResource BrandPrimary}"
             Shell.ForegroundColor="{StaticResource BrandOnPrimary}"
             Shell.TitleColor="{StaticResource BrandOnPrimary}">

  <Grid RowDefinitions="Auto,*">

    <!-- Cabecera -->
    <Grid Grid.Row="0"
          Margin="12,12,12,6">
      <SearchBar x:Name="SearchBox"
                 Placeholder="Buscar secciÃ³nâ€¦"
                 TextChanged="SearchBox_TextChanged"/>
    </Grid>

    <!-- Lista -->
    <RefreshView Grid.Row="1"
                 x:Name="Refresh"
                 Refreshing="Refresh_Refreshing">

      <CollectionView x:Name="SectionsCV"
                      Margin="12,0,12,0"
                      SelectionMode="None"
                      ItemSizingStrategy="MeasureFirstItem"
                      ItemsUpdatingScrollMode="KeepItemsInView">

        <CollectionView.EmptyView>
          <VerticalStackLayout Padding="32"
                               Spacing="8"
                               HorizontalOptions="Center"
                               VerticalOptions="Center">
            <Label Text="Sin secciones"
                   FontAttributes="Bold"
                   Opacity="0.9"
                   TextColor="{AppThemeBinding Light=Black, Dark=White}"/>
            <Button Text="Reintentar"
                    Clicked="Refresh_Refreshing"/>
          </VerticalStackLayout>
        </CollectionView.EmptyView>

        <CollectionView.ItemTemplate>
          <DataTemplate>
            <Border Margin="0,6"
                    Padding="12"
                    BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1E1E1E}"
                    StrokeThickness="0"
                    StrokeShape="{RoundRectangle CornerRadius=12}">
              <Grid ColumnDefinitions="Auto,*,Auto"
                    ColumnSpacing="12"
                    RowDefinitions="Auto,Auto">
                <Border WidthRequest="40"
                        HeightRequest="40"
                        BackgroundColor="{AppThemeBinding Light=#EEE, Dark=#333}"
                        StrokeThickness="0"
                        StrokeShape="{RoundRectangle CornerRadius=10}"
                        Grid.RowSpan="2">
                  <Label Text="ðŸ“„"
                         FontSize="20"
                         HorizontalOptions="Center"
                         VerticalOptions="Center"/>
                </Border>

                <VerticalStackLayout Grid.Column="1"
                                     Grid.Row="0"
                                     Spacing="2">
                  <Label Text="{Binding name}"
                         FontAttributes="Bold"
                         LineBreakMode="TailTruncation"
                         TextColor="{AppThemeBinding Light=Black, Dark=White}"/>
                  <HorizontalStackLayout Spacing="6">
                    <Label Text="{Binding PositionDisplay}"
                           FontSize="12"
                           TextColor="{AppThemeBinding Light=#666, Dark=#AAA}"/>
                    <Label Text="{Binding ItemsBadge}"
                           FontSize="12"
                           TextColor="{AppThemeBinding Light=#666, Dark=#AAA}"/>
                    <Label Text="{Binding CategoryBadge}"
                           FontSize="12"
                           TextColor="{AppThemeBinding Light=#666, Dark=#AAA}"
                           IsVisible="{Binding HasCategory}"/>
                  </HorizontalStackLayout>
                </VerticalStackLayout>

                <HorizontalStackLayout Grid.Column="2"
                                        Grid.Row="0"
                                        Spacing="6"
                                        VerticalOptions="Center">
                  <Switch IsToggled="{Binding isActive}"
                          Toggled="ToggleActivo_Toggled"
                          IsEnabled="{Binding Source={x:Reference Page}, Path=CanUpdate}"/>
                  <Button Text="â‹®"
                          FontSize="16"
                          WidthRequest="36"
                          HeightRequest="36"
                          CornerRadius="18"
                          BackgroundColor="{AppThemeBinding Light=#EEE, Dark=#333}"
                          TextColor="{AppThemeBinding Light=#444, Dark=#DDD}"
                          CommandParameter="{Binding .}"
                          Clicked="More_Clicked"/>
                </HorizontalStackLayout>

                <Button Grid.Column="1"
                        Grid.Row="1"
                        Text="Items"
                        HeightRequest="36"
                        Padding="10,6"
                        Clicked="Items_Clicked"
                        CommandParameter="{Binding .}"
                        BackgroundColor="{AppThemeBinding Light=#894164, Dark=#894164}"
                        TextColor="White"
                        CornerRadius="8"
                        IsEnabled="{Binding Source={x:Reference Page}, Path=CanRead}"
                        IsVisible="{Binding Source={x:Reference Page}, Path=CanRead}"
                        HorizontalOptions="Start"
                        VerticalOptions="Center"/>
              </Grid>
            </Border>
          </DataTemplate>
        </CollectionView.ItemTemplate>

        <CollectionView.Footer>
          <Grid HeightRequest="{OnPlatform Android=120, iOS=120, MacCatalyst=100, WinUI=100}"/>
        </CollectionView.Footer>

      </CollectionView>
    </RefreshView>

    <!-- FABs -->
    <Button Grid.RowSpan="2"
            Text="+"
            Clicked="New_Clicked"
            CornerRadius="28"
            WidthRequest="56"
            HeightRequest="56"
            BackgroundColor="{AppThemeBinding Light=#894164, Dark=#894164}"
            TextColor="White"
            HorizontalOptions="End"
            VerticalOptions="End"
            Margin="16,16,16,32"
            IsEnabled ="{Binding Source={x:Reference Page}, Path=CanCreate}"
            IsVisible="{Binding Source={x:Reference Page}, Path=CanCreate}"
            />

    <Button Grid.RowSpan="2"
            Text="ðŸ—‘"
            Clicked="TrashFab_Clicked"
            CornerRadius="24"
            WidthRequest="48"
            HeightRequest="48"
            BackgroundColor="{AppThemeBinding Light=#4A4A4A, Dark=#222}"
            TextColor="White"
            HorizontalOptions="End"
            VerticalOptions="End"
            Margin="16,16,80,32"
            IsVisible="{Binding Source={x:Reference Page}, Path=ShowTrashFab}"/>

  </Grid>
</ContentPage>

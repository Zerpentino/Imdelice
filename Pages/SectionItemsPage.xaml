<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    x:Class="Imdeliceapp.Pages.SectionItemsPage"
    x:Name="Page"
    Title="{Binding Titulo}"
    BackgroundColor="{AppThemeBinding Light=White, Dark=Black}"
    Shell.NavBarIsVisible="True">

  <Grid RowDefinitions="Auto,*">

    <Grid Grid.Row="0"
          Margin="12,12,12,6">
      <SearchBar x:Name="SearchBox"
                 Placeholder="Buscar Ã­temâ€¦"
                 TextChanged="SearchBox_TextChanged"/>
    </Grid>

    <RefreshView Grid.Row="1"
                 x:Name="Refresh"
                 Refreshing="Refresh_Refreshing">
      <CollectionView x:Name="ItemsCV"
                      Margin="12,0,12,0"
                      SelectionMode="None"
                      ItemsUpdatingScrollMode="KeepScrollOffset"
                      ItemSizingStrategy="MeasureFirstItem">

        <CollectionView.EmptyView>
          <VerticalStackLayout Padding="32"
                               Spacing="8"
                               HorizontalOptions="Center"
                               VerticalOptions="Center">
            <Label Text="Sin Ã­tems"
                   FontAttributes="Bold"
                   TextColor="{AppThemeBinding Light=Black, Dark=White}"/>
          </VerticalStackLayout>
        </CollectionView.EmptyView>

        <CollectionView.ItemTemplate>
          <DataTemplate>
            <Border Margin="0,6"
                    Padding="14"
                    StrokeThickness="0"
                    BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1E1E1E}"
                    StrokeShape="{RoundRectangle CornerRadius=10}">
              <Grid ColumnDefinitions="*,Auto"
                    ColumnSpacing="12"
                    RowDefinitions="Auto,Auto,Auto">
                <Label Text="{Binding Title}"
                       Grid.Row="0" Grid.Column="0"
                       FontAttributes="Bold"
                       LineBreakMode="TailTruncation"
                       MaxLines="2"
                       TextColor="{AppThemeBinding Light=Black, Dark=White}"/>

                <HorizontalStackLayout Grid.Row="1"
                                        Grid.Column="0"
                                        Spacing="6"
                                        Margin="0,4,0,0">
                  <Border BackgroundColor="#EEE" StrokeThickness="0" Padding="6,2"
                          StrokeShape="{RoundRectangle CornerRadius=8}">
                    <Label Text="{Binding TypeBadge}" FontSize="11"/>
                  </Border>
                  <Border BackgroundColor="#E6F4EA" StrokeThickness="0" Padding="6,2"
                          StrokeShape="{RoundRectangle CornerRadius=8}"
                          IsVisible="{Binding HasCustomPrice}">
                    <Label Text="{Binding PriceLabel}" FontSize="11" TextColor="#1B5E20"/>
                  </Border>
                  <Border BackgroundColor="#FAD7D7" StrokeThickness="0" Padding="6,2"
                          StrokeShape="{RoundRectangle CornerRadius=8}"
                          IsVisible="{Binding IsInactiveBadgeVisible}">
                    <Label Text="Inactivo" FontSize="11" TextColor="#B71C1C"/>
                  </Border>
                  <Border BackgroundColor="#FFF3CD" StrokeThickness="0" Padding="6,2"
                          StrokeShape="{RoundRectangle CornerRadius=8}"
                          IsVisible="{Binding IsFeatured}">
                    <Label Text="Destacado" FontSize="11" TextColor="#8A6D3B"/>
                  </Border>
                  <Border BackgroundColor="#EEE" StrokeThickness="0" Padding="6,2"
                          StrokeShape="{RoundRectangle CornerRadius=8}">
                    <Label Text="{Binding PositionLabel}" FontSize="11"/>
                  </Border>
                </HorizontalStackLayout>

                <Label Grid.Row="2" Grid.Column="0"
                       Text="{Binding ReferenceLabel}"
                       FontSize="12"
                       TextColor="{AppThemeBinding Light=#666, Dark=#AAA}"
                       Margin="0,4,0,0"/>

                <VerticalStackLayout Grid.Column="1"
                                     Grid.RowSpan="3"
                                     Spacing="6"
                                     HorizontalOptions="End"
                                     VerticalOptions="Center">
                  <Switch IsEnabled="{Binding Source={x:Reference Page}, Path=CanUpdate}"
                          IsToggled="{Binding isActive}"
                          Toggled="ToggleActivo_Toggled"/>
                  <Button Text="Editar"
                          Padding="10,6"
                          CornerRadius="10"
                          FontSize="12"
                          BackgroundColor="#4CAF50"
                          TextColor="White"
                          CommandParameter="{Binding}"
                          Clicked="Edit_Clicked"
                          IsVisible="{Binding Source={x:Reference Page}, Path=CanUpdate}"
                          IsEnabled="{Binding Source={x:Reference Page}, Path=CanUpdate}"/>
                  <Button Text="Eliminar"
                          Padding="10,6"
                          CornerRadius="10"
                          FontSize="12"
                          BackgroundColor="#E53935"
                          TextColor="White"
                          CommandParameter="{Binding}"
                          Clicked="Delete_Clicked"
                          IsVisible="{Binding Source={x:Reference Page}, Path=CanDelete}"
                          IsEnabled="{Binding Source={x:Reference Page}, Path=CanDelete}"/>
                </VerticalStackLayout>
              </Grid>
            </Border>
          </DataTemplate>
        </CollectionView.ItemTemplate>

        <CollectionView.Footer>
          <Grid HeightRequest="120"/>
        </CollectionView.Footer>
      </CollectionView>
    </RefreshView>

    <Button Grid.RowSpan="2"
            Text="+"
            Clicked="New_Clicked"
            CornerRadius="28"
            WidthRequest="56"
            HeightRequest="56"
            BackgroundColor="{AppThemeBinding Light=#894164, Dark=#894164}"
            TextColor="White"
            HorizontalOptions="End"
            VerticalOptions="End"
            Margin="16,16,16,32"
            IsVisible="{Binding Source={x:Reference Page}, Path=CanCreate}"/>

    <Button Grid.RowSpan="2"
            Text="ðŸ—‘"
            Clicked="TrashFab_Clicked"
            CornerRadius="24"
            WidthRequest="48"
            HeightRequest="48"
            BackgroundColor="{AppThemeBinding Light=#4A4A4A, Dark=#222}"
            TextColor="White"
            HorizontalOptions="End"
            VerticalOptions="End"
            Margin="16,16,84,32"
            IsVisible="{Binding Source={x:Reference Page}, Path=ShowTrashFab}"/>

  </Grid>
</ContentPage>

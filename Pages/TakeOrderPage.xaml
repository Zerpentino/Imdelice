<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Name="PageRoot"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:Class="Imdeliceapp.Pages.TakeOrderPage"
             BackgroundColor="{AppThemeBinding Light=White, Dark=Black}">

  <Grid RowDefinitions="Auto,Auto,*">
    <VerticalStackLayout Grid.Row="0"
                         Padding="16,20,16,12"
                         Spacing="12">
      <Picker x:Name="MenuPicker"
              Title="Selecciona un menÃº"
              ItemsSource="{Binding MenuOptions}"
              ItemDisplayBinding="{Binding DisplayName}"
              SelectedItem="{Binding SelectedMenu}"
              IsVisible="{Binding HasMenuOptions}" />

      <SearchBar x:Name="SearchBox"
                 Placeholder="Buscar productos o combos..."
                 TextChanged="SearchBox_TextChanged"/>
    </VerticalStackLayout>

    <Border Grid.Row="1"
            StrokeThickness="0"
            BackgroundColor="{AppThemeBinding Light=#f5f2f4, Dark=#1e1e1e}"
            Padding="8,0">
      <CollectionView x:Name="SectionsView"
                      ItemsSource="{Binding Sections}"
                      SelectionMode="Single"
                      SelectionChanged="SectionsView_SelectionChanged"
                      HorizontalScrollBarVisibility="Never">
        <CollectionView.ItemsLayout>
          <LinearItemsLayout Orientation="Horizontal" ItemSpacing="8"/>
        </CollectionView.ItemsLayout>
        <CollectionView.ItemTemplate>
          <DataTemplate>
            <Border Padding="12,8"
                    BackgroundColor="{Binding ChipBackground}"
                    StrokeThickness="0"
                    StrokeShape="{RoundRectangle CornerRadius=18}">
              <HorizontalStackLayout Spacing="6">
                <Label Text="{Binding Name}"
                       FontAttributes="Bold"
                       TextColor="{Binding ChipTextColor}"/>
                <Label Text="{Binding ItemsCount}"
                       FontSize="11"
                       Opacity="0.7"
                       VerticalOptions="Center"/>
              </HorizontalStackLayout>
            </Border>
          </DataTemplate>
        </CollectionView.ItemTemplate>
      </CollectionView>
    </Border>

    <Grid Grid.Row="2">
      <CollectionView x:Name="ItemsView"
                      ItemsSource="{Binding VisibleItems}"
                      SelectionMode="None"
                      ItemSizingStrategy="MeasureAllItems"
                      Margin="16"
                      VerticalScrollBarVisibility="Never">
        <CollectionView.ItemsLayout>
          <GridItemsLayout Orientation="Vertical" Span="2"/>
        </CollectionView.ItemsLayout>
        <CollectionView.EmptyView>
          <VerticalStackLayout Padding="40"
                               HorizontalOptions="Center"
                               VerticalOptions="Center"
                               Spacing="6">
            <Label Text="Sin resultados"
                   FontAttributes="Bold"
                   FontSize="18"
                   Opacity="0.85"/>
            <Label Text="Prueba con otro tÃ©rmino o cambia de secciÃ³n."
                   FontSize="12"
                   Opacity="0.6"/>
          </VerticalStackLayout>
        </CollectionView.EmptyView>

        <CollectionView.ItemTemplate>
          <DataTemplate>
            <Border Margin="6"
                    BackgroundColor="{AppThemeBinding Light=White, Dark=#252525}"
                    Stroke="{AppThemeBinding Light=#E0E0E0, Dark=#3A3A3A}"
                    StrokeShape="{RoundRectangle CornerRadius=18}">
              <Grid RowDefinitions="*,Auto"
                    ColumnDefinitions="*"
                    Padding="12">
                <VerticalStackLayout Spacing="6">
                  <Frame HeightRequest="120"
                         CornerRadius="14"
                         HasShadow="False"
                         BackgroundColor="{AppThemeBinding Light=#f8f8f8, Dark=#1b1b1b}">
                    <Image Source="{Binding ImageSource}"
                           Aspect="AspectFill"/>
                  </Frame>
                  <Label Text="{Binding Title}"
                         FontAttributes="Bold"
                         LineBreakMode="TailTruncation"
                         MaxLines="2"/>
                  <Label Text="{Binding Subtitle}"
                         FontSize="12"
                         TextColor="{AppThemeBinding Light=#6A6A6A, Dark=#B0B0B0}"
                         LineBreakMode="TailTruncation"
                         MaxLines="2"
                         IsVisible="{Binding HasSubtitle}"/>
                  <Label Text="{Binding ReferenceLabel}"
                         FontSize="11"
                         TextColor="{AppThemeBinding Light=#8A8A8A, Dark=#888}"
                         IsVisible="{Binding HasReferenceLabel}"/>
                </VerticalStackLayout>

                <HorizontalStackLayout Grid.Row="1"
                                       Spacing="6"
                                       VerticalOptions="End"
                                       HorizontalOptions="Fill">
                  <Label Text="{Binding PriceLabel}"
                         FontAttributes="Bold"
                         FontSize="16"
                         VerticalOptions="Center"
                         HorizontalOptions="StartAndExpand"/>
                  <Button Text="Agregar"
                          CornerRadius="18"
                          Padding="14,6"
                          Command="{Binding Source={x:Reference Name=PageRoot}, Path=BindingContext.ConfigureItemCommand}"
                          CommandParameter="{Binding}"/>
                </HorizontalStackLayout>
              </Grid>
            </Border>
          </DataTemplate>
        </CollectionView.ItemTemplate>
      </CollectionView>
    </Grid>

    <Button Grid.RowSpan="3"
            Text="ðŸ§¾ Carrito (0)" x:Name="FabCart"
            BackgroundColor="{AppThemeBinding Light=#521739, Dark=#D5B2C2}"
            TextColor="White" CornerRadius="24" Padding="20,12"
            Clicked="OpenCart_Clicked"
            HorizontalOptions="End" VerticalOptions="End"
            Margin="16,24"/>

    <ActivityIndicator Grid.RowSpan="3"
                       x:Name="LoadingIndicator"
                       IsVisible="False"
                       IsRunning="False"
                       HorizontalOptions="Center"
                       VerticalOptions="Center"/>
  </Grid>
</ContentPage>

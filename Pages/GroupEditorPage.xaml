<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
  xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
  xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
  x:Class="Imdeliceapp.Pages.GroupEditorPage"
  Title="Editar grupo"
  Shell.NavBarIsVisible="True">

  <ContentPage.Resources>
    <Color x:Key="CardBgLight">#FFFFFF</Color>
    <Color x:Key="CardBgDark">#1E1E1E</Color>
    <Color x:Key="CardBorderLight">#E2E2E2</Color>
    <Color x:Key="CardBorderDark">#383838</Color>

    <Style x:Key="CardContainerStyle" TargetType="Border">
      <Setter Property="StrokeThickness" Value="1"/>
      <Setter Property="Stroke">
        <Setter.Value>
          <AppThemeBinding Light="{StaticResource CardBorderLight}"
                           Dark="{StaticResource CardBorderDark}"/>
        </Setter.Value>
      </Setter>
      <Setter Property="BackgroundColor">
        <Setter.Value>
          <AppThemeBinding Light="{StaticResource CardBgLight}"
                           Dark="{StaticResource CardBgDark}"/>
        </Setter.Value>
      </Setter>
      <Setter Property="StrokeShape">
        <Setter.Value>
          <RoundRectangle CornerRadius="18"/>
        </Setter.Value>
      </Setter>
      <Setter Property="Padding" Value="18"/>
    </Style>

    <Style x:Key="TinyLabelStyle" TargetType="Label">
      <Setter Property="FontSize" Value="12"/>
      <Setter Property="TextColor" Value="{AppThemeBinding Light=#555, Dark=#B5B5B5}"/>
    </Style>
  </ContentPage.Resources>

  <ContentPage.ToolbarItems>
    <ToolbarItem Text="Guardar"
        Order="Primary"
        Priority="0"
        Clicked="Save_Clicked"/>
  </ContentPage.ToolbarItems>

  <ScrollView>

    <VerticalStackLayout Padding="16"
        Spacing="16">
      <!-- Debajo de <ScrollView> o al principio del Stack -->
      <ActivityIndicator x:Name="SavingSpinner"
                         IsRunning="False"
                         IsVisible="False"
                         Margin="0,6"/>

      <!-- ===== DATOS DEL GRUPO ===== -->
      <Border Style="{StaticResource CardContainerStyle}">
        <VerticalStackLayout Spacing="14">

          <Label Text="Datos del grupo"
              FontAttributes="Bold"
                 TextColor="{AppThemeBinding Light=Black, Dark=White}"/>

          <!-- Nombre -->
          <VerticalStackLayout Spacing="4">
            <Label Text="Nombre"
                   Style="{StaticResource TinyLabelStyle}"/>
            <Entry x:Name="NameEntry"
                   Placeholder="p. ej. Tamaño"/>
          </VerticalStackLayout>

          <!-- Descripción -->
          <VerticalStackLayout Spacing="4">
            <Label Text="Descripción"
                   Style="{StaticResource TinyLabelStyle}"/>
            <Editor x:Name="DescEntry"
                    Placeholder="p. ej. Elige un tamaño"
                    AutoSize="TextChanges"
                    MaxLength="140"/>

          </VerticalStackLayout>

          <!-- Min / Max -->
          <Grid ColumnDefinitions="*,*"
                ColumnSpacing="12">
            <VerticalStackLayout Spacing="4">
              <Label Text="Mín. selecciones"
                     Style="{StaticResource TinyLabelStyle}"/>
              <Entry x:Name="MinEntry"
                     Keyboard="Numeric"
                     Placeholder="0"/>
            </VerticalStackLayout>

            <VerticalStackLayout Spacing="4"
                                 Grid.Column="1">
              <Label Text="Máx. selecciones"
                     Style="{StaticResource TinyLabelStyle}"/>
              <Entry x:Name="MaxEntry"
                     Keyboard="Numeric"
                     Placeholder="vacío = sin tope"/>
            </VerticalStackLayout>
          </Grid>

          <!-- Switches -->
          <Grid ColumnDefinitions="*,*"
              ColumnSpacing="12">
            <HorizontalStackLayout Spacing="10">
              <Label Text="Obligatorio"
                    VerticalTextAlignment="Center"
                    TextColor="{AppThemeBinding Light=#333, Dark=#CCC}"/>
              <Switch x:Name="ReqSwitch"
                      HeightRequest="32"/>

            </HorizontalStackLayout>

            <HorizontalStackLayout Spacing="10"
                Grid.Column="1">
              <Label Text="Activo"
                    VerticalTextAlignment="Center"
                    TextColor="{AppThemeBinding Light=#333, Dark=#CCC}"/>
              <Switch x:Name="ActiveSwitch"
                      HeightRequest="32"/>

            </HorizontalStackLayout>
          </Grid>

        </VerticalStackLayout>
      </Border>

      <!-- ===== AVANZADO ===== -->
      <Border Style="{StaticResource CardContainerStyle}">
        <VerticalStackLayout Spacing="14">
          <Label Text="Avanzado"
              FontAttributes="Bold"
                 TextColor="{AppThemeBinding Light=Black, Dark=White}"/>

          <Grid ColumnDefinitions="*,*"
                ColumnSpacing="12">
            <VerticalStackLayout Spacing="4">
              <Label Text="Posición"
                     Style="{StaticResource TinyLabelStyle}"/>
              <Entry x:Name="PositionEntry"
                     Keyboard="Numeric"
                     Placeholder="0"/>
            </VerticalStackLayout>

            <VerticalStackLayout Spacing="4"
                Grid.Column="1">
              <Label Text="Categoría (opcional)"
                     Style="{StaticResource TinyLabelStyle}"/>
              <Grid ColumnDefinitions="*,Auto"
                  ColumnSpacing="6">
                <Picker x:Name="CategoryPicker"
                        ItemsSource="{Binding Categories}"
                        ItemDisplayBinding="{Binding name}"
                        Title="vacío = ninguna"
                        SelectedIndexChanged="CategoryPicker_SelectedIndexChanged"/>
                <Button Grid.Column="1"
                    Text="✕"
                    Padding="10,6"
                        Clicked="ClearCategory_Clicked"/>
              </Grid>
            </VerticalStackLayout>

          </Grid>
        </VerticalStackLayout>
      </Border>

      <!-- ===== OPCIONES ===== -->
      <VerticalStackLayout Spacing="8">
        <Label Text="Opciones"
            FontAttributes="Bold"
               TextColor="{AppThemeBinding Light=Black, Dark=White}"/>

        <CollectionView x:Name="OptsCV"
                        ItemsSource="{Binding Options}"
                        SelectionMode="None">
          <CollectionView.EmptyView>
            <VerticalStackLayout Padding="16"
                Spacing="4"
                                 HorizontalOptions="Center"
                VerticalOptions="Center">
              <Label Text="Sin opciones aún"
                     TextColor="{AppThemeBinding Light=#666, Dark=#AAA}"/>
            </VerticalStackLayout>
          </CollectionView.EmptyView>

          <CollectionView.ItemTemplate>
            <DataTemplate>
              <!-- Tarjeta de opción -->
              <Border Style="{StaticResource CardContainerStyle}"
                      Margin="0,6">
                <VerticalStackLayout Spacing="12">

                  <Grid ColumnDefinitions="*,120"
                        ColumnSpacing="12">
                    <VerticalStackLayout Spacing="4">
                      <Label Text="Nombre"
                             Style="{StaticResource TinyLabelStyle}"/>
                      <Entry Text="{Binding name}"
                             Placeholder="Nombre de opción"/>
                    </VerticalStackLayout>

                    <VerticalStackLayout Spacing="4"
                                         Grid.Column="1">
                      <Label Text="Precio (MXN)"
                             Style="{StaticResource TinyLabelStyle}"/>
                      <Entry Text="{Binding priceDisplay, Mode=TwoWay}"
                             Placeholder="0.00"
                             Keyboard="Numeric"
                             HorizontalTextAlignment="Center"/>
                    </VerticalStackLayout>
                  </Grid>

                  <!-- Default / Activo + acciones (limpio y alineado) -->
                  <Grid ColumnDefinitions="*,*,Auto,Auto,Auto"
                        ColumnSpacing="12">
                    <VerticalStackLayout Spacing="4"
                                         VerticalOptions="Center">
                      <Label Text="Default"
                             Style="{StaticResource TinyLabelStyle}"/>
                      <Switch IsToggled="{Binding isDefault}"
                              Toggled="Default_Toggled"/>
                    </VerticalStackLayout>

                    <VerticalStackLayout Spacing="4"
                                         Grid.Column="1"
                                         VerticalOptions="Center">
                      <Label Text="Activo"
                             Style="{StaticResource TinyLabelStyle}"/>
                      <Switch IsToggled="{Binding isActive, Mode=TwoWay}"
                              Toggled="OptionActive_Toggled"/>
                    </VerticalStackLayout>

                    <Button Grid.Column="2"
                            Text="↑"
                            Style="{StaticResource SecondaryPillSmButtonStyle}"
                            Clicked="MoveUp_Clicked"/>
                    <Button Grid.Column="3"
                            Text="↓"
                            Style="{StaticResource SecondaryPillSmButtonStyle}"
                            Clicked="MoveDown_Clicked"/>
                    <Button Grid.Column="4"
                            Text="✕"
                            Style="{StaticResource SecondaryPillSmButtonStyle}"
                            Clicked="RemoveOption_Clicked"/>

                  </Grid>



                </VerticalStackLayout>
              </Border>
            </DataTemplate>
          </CollectionView.ItemTemplate>
        </CollectionView>

        <Button Text="Agregar opción"
                Style="{StaticResource SecondaryPillButtonStyle}"
                Clicked="AddOption_Clicked"/>
      </VerticalStackLayout>

      <!-- Botón guardar alternativo (además del Toolbar) -->
      <Button Text="Guardar"
              Style="{StaticResource PrimaryButtonStyle}"
              Clicked="Save_Clicked"/>

      <!-- Espacio inferior para no chocar con la barra -->
      <Grid HeightRequest="12"/>
    </VerticalStackLayout>

  </ScrollView>


</ContentPage>


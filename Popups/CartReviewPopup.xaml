<?xml version="1.0" encoding="utf-8" ?>
<toolkit:Popup xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
               xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
               xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
               x:Class="Imdeliceapp.Popups.CartReviewPopup"
               CanBeDismissedByTappingOutsideOfPopup="True">
  <Border Stroke="{AppThemeBinding Light=#DDDDDD, Dark=#333333}"
          StrokeShape="{RoundRectangle CornerRadius=24}"
          BackgroundColor="{AppThemeBinding Light=White, Dark=#181818}"
          Padding="0">
    <Grid Padding="20"
          RowDefinitions="Auto,*,Auto"
          RowSpacing="16"
          WidthRequest="420">
      <Grid ColumnDefinitions="*,Auto"
            VerticalOptions="Center">
        <Label Text="Resumen de la orden"
               FontAttributes="Bold"
               FontSize="20"/>
        <Button Grid.Column="1"
                Text="✕"
                FontSize="16"
                WidthRequest="32"
                HeightRequest="32"
                Padding="0"
                BackgroundColor="Transparent"
                Clicked="CloseButton_Clicked"/>
      </Grid>

      <ScrollView Grid.Row="1">
        <VerticalStackLayout Spacing="16">
          <Border Stroke="{AppThemeBinding Light=#EFE0E7, Dark=#2C1D25}"
                  StrokeShape="{RoundRectangle CornerRadius=18}"
                  BackgroundColor="{AppThemeBinding Light=#FBF8FA, Dark=#22151D}"
                  Padding="14">
            <VerticalStackLayout Spacing="12">
              <Grid ColumnDefinitions="*,Auto"
                    VerticalOptions="Center">
                <Label Text="Detalles del pedido"
                       FontAttributes="Bold"
                       FontSize="16"/>
                <Button Grid.Column="1"
                        Text="{Binding IsDetailsExpanded, Converter={StaticResource BoolToIconConverter}}"
                        Command="{Binding ToggleDetailsCommand}"
                        WidthRequest="36"
                        HeightRequest="36"
                        Padding="0"
                        BackgroundColor="Transparent"
                        FontSize="18"
                        TextColor="{AppThemeBinding Light=#333333, Dark=#DDDDDD}"/>
              </Grid>

              <VerticalStackLayout Spacing="14"
                                   IsVisible="{Binding IsDetailsExpanded}">
                <Grid ColumnDefinitions="*,*"
                      ColumnSpacing="12">
                  <VerticalStackLayout Spacing="6">
                    <Label Text="Tipo de servicio"
                           FontSize="12"
                           TextColor="{AppThemeBinding Light=#7A7480, Dark=#C6BAC4}"/>
                    <Picker ItemsSource="{Binding ServiceTypeOptions}"
                            SelectedItem="{Binding SelectedServiceType}"
                            ItemDisplayBinding="{Binding Display}"
                            Title="Selecciona el tipo de servicio"/>
                  </VerticalStackLayout>

                  <VerticalStackLayout Grid.Column="1"
                                       Spacing="6">
                    <Label Text="Canal"
                           FontSize="12"
                           TextColor="{AppThemeBinding Light=#7A7480, Dark=#C6BAC4}"/>
                    <Picker ItemsSource="{Binding SourceOptions}"
                            SelectedItem="{Binding SelectedSource}"
                            ItemDisplayBinding="{Binding Display}"
                            Title="Canal de origen"
                            IsEnabled="{Binding IsSourceEnabled}"/>
                  </VerticalStackLayout>
                </Grid>

                <VerticalStackLayout Spacing="4"
                                     IsVisible="{Binding ShowMarkupField}">
                  <Label Text="Recargo del canal (%)"
                         FontSize="12"
                         TextColor="{AppThemeBinding Light=#7A7480, Dark=#C6BAC4}"/>
                  <Entry Text="{Binding MarkupText}"
                         Placeholder="Ej. 46"
                         Keyboard="Numeric"
                         MaxLength="3"
                         WidthRequest="100"/>
                  <Label Text="{Binding MarkupHint}"
                         FontSize="11"
                         TextColor="{AppThemeBinding Light=#9A92A0, Dark=#BFAFBB}"
                         LineBreakMode="WordWrap"
                         MaxLines="2"/>
                </VerticalStackLayout>

                <Grid ColumnDefinitions="*,*"
                      ColumnSpacing="12">
                  <VerticalStackLayout Spacing="6">
                    <Label Text="Estado inicial"
                           FontSize="12"
                           TextColor="{AppThemeBinding Light=#7A7480, Dark=#C6BAC4}"/>
                    <Picker ItemsSource="{Binding StatusOptions}"
                            SelectedItem="{Binding SelectedStatus}"
                            ItemDisplayBinding="{Binding Display}"
                            Title="Estado de la orden"/>
                  </VerticalStackLayout>

                  <VerticalStackLayout Grid.Column="1"
                                       Spacing="6"
                                       IsVisible="{Binding ShowTableSelectors}">
                    <Label Text="Mesa"
                           FontSize="12"
                           TextColor="{AppThemeBinding Light=#7A7480, Dark=#C6BAC4}"/>
                    <Grid ColumnDefinitions="*,Auto"
                          ColumnSpacing="6">
                      <Picker ItemsSource="{Binding TableOptions}"
                              SelectedItem="{Binding SelectedTable}"
                              ItemDisplayBinding="{Binding DisplayName}"
                              Title="Selecciona la mesa"/>
                      <ActivityIndicator Grid.Column="1"
                                          IsRunning="{Binding IsLoadingTables}"
                                          IsVisible="{Binding IsLoadingTables}"
                                          VerticalOptions="Center"/>
                    </Grid>
                  </VerticalStackLayout>
                </Grid>

                <Grid ColumnDefinitions="*,*"
                      ColumnSpacing="12">
                  <VerticalStackLayout Spacing="6">
                    <Label Text="Personas"
                           FontSize="12"
                           TextColor="{AppThemeBinding Light=#7A7480, Dark=#C6BAC4}"/>
                    <Entry Text="{Binding CoversText}"
                           Keyboard="Numeric"
                           Placeholder="0"/>
                  </VerticalStackLayout>

                  <VerticalStackLayout Grid.Column="1"
                                       Spacing="6">
                    <Label Text="Tiempo prep (min)"
                           FontSize="12"
                           TextColor="{AppThemeBinding Light=#7A7480, Dark=#C6BAC4}"/>
                    <Entry Text="{Binding PrepEtaText}"
                           Keyboard="Numeric"
                           Placeholder="30"/>
                  </VerticalStackLayout>
                </Grid>

                <Grid ColumnDefinitions="*,Auto"
                      ColumnSpacing="12">
                  <VerticalStackLayout Spacing="6">
                    <Label Text="Notas"
                           FontSize="12"
                           TextColor="{AppThemeBinding Light=#7A7480, Dark=#C6BAC4}"/>
                    <Editor Text="{Binding Note}"
                            AutoSize="TextChanges"
                            Placeholder="Agregar indicaciones especiales"/>
                  </VerticalStackLayout>
                  <VerticalStackLayout Grid.Column="1"
                                       Spacing="6">
                    <Label Text="Atiende"
                           FontSize="12"
                           TextColor="{AppThemeBinding Light=#7A7480, Dark=#C6BAC4}"/>
                    <Border StrokeThickness="1"
                            Stroke="{AppThemeBinding Light=#E3DFE6, Dark=#3A2E36}"
                            StrokeShape="{RoundRectangle CornerRadius=12}"
                            Padding="12,10">
                      <Label Text="{Binding ServedByDisplay}"
                             FontAttributes="Bold"
                             VerticalOptions="Center"
                             HorizontalOptions="Start"/>
                    </Border>
                  </VerticalStackLayout>
                </Grid>

                <VerticalStackLayout Spacing="10"
                                     IsVisible="{Binding ShowCustomerFields}">
                  <Grid ColumnDefinitions="*,*"
                        ColumnSpacing="12">
                    <VerticalStackLayout Spacing="6">
                      <Label Text="Cliente"
                             FontSize="12"
                             TextColor="{AppThemeBinding Light=#7A7480, Dark=#C6BAC4}"/>
                      <Entry Text="{Binding CustomerName}"
                             Placeholder="Nombre del cliente"/>
                    </VerticalStackLayout>

                    <VerticalStackLayout Grid.Column="1"
                                         Spacing="6">
                      <Label Text="Teléfono"
                             FontSize="12"
                             TextColor="{AppThemeBinding Light=#7A7480, Dark=#C6BAC4}"/>
                      <Entry Text="{Binding CustomerPhone}"
                             Placeholder="Contacto"
                             Keyboard="Telephone"/>
                    </VerticalStackLayout>
                  </Grid>

                  <VerticalStackLayout Spacing="6">
                    <Label Text="Referencia externa"
                           FontSize="12"
                           TextColor="{AppThemeBinding Light=#7A7480, Dark=#C6BAC4}"/>
                    <Entry Text="{Binding ExternalRef}"
                           Placeholder="Número de pedido del proveedor"/>
                  </VerticalStackLayout>

                  <VerticalStackLayout Spacing="6"
                                       IsVisible="{Binding ShowDeliveryFee}">
                    <Label Text="Costo de envío"
                           FontSize="12"
                           TextColor="{AppThemeBinding Light=#7A7480, Dark=#C6BAC4}"/>
                    <Entry Text="{Binding DeliveryFeeText}"
                           Placeholder="Ej. 35.00"
                           Keyboard="Numeric"/>
                  </VerticalStackLayout>
                </VerticalStackLayout>
              </VerticalStackLayout>
            </VerticalStackLayout>
          </Border>

          <VerticalStackLayout Spacing="10">
            <Label Text="Productos"
                   FontAttributes="Bold"
                   FontSize="16"/>

            <Label Text="No hay productos agregados."
                   FontSize="13"
                   HorizontalOptions="Center"
                   TextColor="{AppThemeBinding Light=#7A7480, Dark=#C6BAC4}"
                   IsVisible="True">
              <Label.Triggers>
                <DataTrigger TargetType="Label"
                             Binding="{Binding HasItems}"
                             Value="True">
                  <Setter Property="IsVisible" Value="False"/>
                </DataTrigger>
              </Label.Triggers>
            </Label>

            <VerticalStackLayout x:Name="ItemsHost"
                                 Spacing="10"
                                 BindableLayout.ItemsSource="{Binding Items}">
              <BindableLayout.ItemTemplate>
                <DataTemplate>
                  <Border StrokeThickness="1"
                          Stroke="{AppThemeBinding Light=#E7E0E5, Dark=#333333}"
                          StrokeShape="{RoundRectangle CornerRadius=16}"
                          Padding="14">
                    <VerticalStackLayout Spacing="10">
                      <Grid ColumnDefinitions="*,Auto"
                            ColumnSpacing="12">
                        <VerticalStackLayout Spacing="4">
                          <Label Text="{Binding Title}"
                                 FontAttributes="Bold"
                                 FontSize="15"/>
                          <Label Text="{Binding Subtitle}"
                                 FontSize="12"
                                 TextColor="{AppThemeBinding Light=#7A7480, Dark=#C6BAC4}"
                                 LineBreakMode="WordWrap"
                                 IsVisible="True">
                            <Label.Triggers>
                              <Trigger TargetType="Label"
                                       Property="Text"
                                       Value="">
                                <Setter Property="IsVisible" Value="False"/>
                              </Trigger>
                              <Trigger TargetType="Label"
                                       Property="Text"
                                       Value="{x:Null}">
                                <Setter Property="IsVisible" Value="False"/>
                              </Trigger>
                            </Label.Triggers>
                          </Label>
                        </VerticalStackLayout>
                        <Label Grid.Column="1"
                               Text="{Binding LineTotal, StringFormat='{}{0:C}'}"
                               FontAttributes="Bold"
                               VerticalOptions="Start"/>
                      </Grid>

                      <VerticalStackLayout Spacing="4"
                                           IsVisible="{Binding HasComboChildren}">
                        <Label Text="Incluye"
                               FontSize="12"
                               FontAttributes="Bold"
                               TextColor="{AppThemeBinding Light=#7A7480, Dark=#C6BAC4}"/>
                        <VerticalStackLayout BindableLayout.ItemsSource="{Binding ComboChildren}"
                                             Spacing="2">
                          <BindableLayout.ItemTemplate>
                            <DataTemplate>
                              <VerticalStackLayout Spacing="2">
                                <Label Text="{Binding DisplayLabel}"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light=#7A7480, Dark=#C6BAC4}"/>
                                <Label Text="{Binding Detail}"
                                       FontSize="11"
                                       TextColor="{AppThemeBinding Light=#B39EB5, Dark=#9B8594}"
                                       IsVisible="{Binding HasDetail}"/>
                              </VerticalStackLayout>
                            </DataTemplate>
                          </BindableLayout.ItemTemplate>
                        </VerticalStackLayout>
                      </VerticalStackLayout>

                      <Grid ColumnDefinitions="Auto,*,Auto,Auto"
                            ColumnSpacing="12"
                            VerticalOptions="Center">
                        <VerticalStackLayout Spacing="4">
                          <Label Text="Cantidad"
                                 FontSize="12"
                                 TextColor="{AppThemeBinding Light=#7A7480, Dark=#C6BAC4}"/>
                          <HorizontalStackLayout Spacing="6"
                                                 VerticalOptions="Center">
                            <Button Text="−"
                                    WidthRequest="32"
                                    HeightRequest="32"
                                    CornerRadius="16"
                                    Padding="0"
                                    BackgroundColor="{AppThemeBinding Light=#F5E5EC, Dark=#3A1F2B}"
                                    TextColor="{AppThemeBinding Light=#A03F5F, Dark=#F0BBD0}"
                                    CommandParameter="{Binding .}"
                                    Clicked="DecreaseQuantity_Clicked">
                              <Button.Triggers>
                                <DataTrigger TargetType="Button"
                                             Binding="{Binding Quantity}"
                                             Value="1">
                                  <Setter Property="IsEnabled" Value="False"/>
                                  <Setter Property="Opacity" Value="0.5"/>
                                </DataTrigger>
                              </Button.Triggers>
                            </Button>

                            <Frame WidthRequest="36"
                                   HeightRequest="36"
                                   CornerRadius="18"
                                   Padding="0"
                                   BorderColor="{AppThemeBinding Light=#E0C7D6, Dark=#3A2532}"
                                   BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1E1A1F}"
                                   HasShadow="False"
                                   VerticalOptions="Center">
                              <Label Text="{Binding Quantity}"
                                     HorizontalOptions="Center"
                                     VerticalOptions="Center"
                                     FontAttributes="Bold"/>
                            </Frame>

                            <Button Text="+"
                                    WidthRequest="32"
                                    HeightRequest="32"
                                    CornerRadius="16"
                                    Padding="0"
                                    BackgroundColor="{AppThemeBinding Light=#F1E9F1, Dark=#2B1D29}"
                                    TextColor="{AppThemeBinding Light=#894164, Dark=#D5B2C2}"
                                    CommandParameter="{Binding .}"
                                    Clicked="IncreaseQuantity_Clicked"/>
                          </HorizontalStackLayout>
                        </VerticalStackLayout>

                        <VerticalStackLayout Grid.Column="1"
                                             Spacing="2">
                          <Label Text="{Binding UnitPrice, StringFormat='Unitario {0:C}'}"
                                 FontSize="12"
                                 TextColor="{AppThemeBinding Light=#7A7480, Dark=#C6BAC4}"/>
                          <Label Text="{Binding ExtrasTotal, StringFormat='Extras {0:C}'}"
                                 FontSize="12"
                                 TextColor="{AppThemeBinding Light=#7A7480, Dark=#C6BAC4}"/>
                        </VerticalStackLayout>

                        <Button Grid.Column="2"
                                Text="Editar"
                                Padding="12,8"
                                BackgroundColor="{AppThemeBinding Light=#F1E9F1, Dark=#2B1D29}"
                                TextColor="{AppThemeBinding Light=#894164, Dark=#D5B2C2}"
                                CommandParameter="{Binding .}"
                                Clicked="EditButton_Clicked"/>
                        <Button Grid.Column="3"
                                Text="Quitar"
                                Padding="12,8"
                                BackgroundColor="{AppThemeBinding Light=#F5E5EC, Dark=#3A1F2B}"
                                TextColor="{AppThemeBinding Light=#A03F5F, Dark=#F0BBD0}"
                                CommandParameter="{Binding .}"
                                Clicked="RemoveButton_Clicked"/>
                      </Grid>
                    </VerticalStackLayout>
                  </Border>
                </DataTemplate>
              </BindableLayout.ItemTemplate>
            </VerticalStackLayout>
          </VerticalStackLayout>
        </VerticalStackLayout>
      </ScrollView>

      <VerticalStackLayout Grid.Row="2"
                           Spacing="12">
        <Grid ColumnDefinitions="*,Auto">
          <Label Text="Total"
                 FontAttributes="Bold"
                 FontSize="16"/>
          <Label Grid.Column="1"
                 Text="{Binding TotalFormatted}"
                 FontAttributes="Bold"
                 FontSize="16"/>
        </Grid>

        <Grid ColumnDefinitions="*,*"
              ColumnSpacing="12">
          <Button Text="Seguir pidiendo"
                  Command="{Binding ContinueCommand}"
                  BackgroundColor="{AppThemeBinding Light=#F1E9F1, Dark=#2B1D29}"
                  TextColor="{AppThemeBinding Light=#894164, Dark=#D5B2C2}"/>
          <Button Grid.Column="1"
                  Text="Enviar orden"
                  Command="{Binding CheckoutCommand}"
                  BackgroundColor="#894164"
                  TextColor="White"
                  IsEnabled="{Binding CanCheckout}"/>
        </Grid>
      </VerticalStackLayout>
    </Grid>
  </Border>
</toolkit:Popup>

<?xml version="1.0" encoding="utf-8" ?>
<toolkit:Popup xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
               xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
               xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
               x:Class="Imdeliceapp.Popups.ConfigureMenuItemPopup"
               
               CanBeDismissedByTappingOutsideOfPopup="False">
  <Border Stroke="{AppThemeBinding Light=#DDDDDD, Dark=#333333}"
          StrokeShape="{RoundRectangle CornerRadius=24}"
          BackgroundColor="{AppThemeBinding Light=White, Dark=#181818}"
          Padding="0">
    <Grid RowDefinitions="*">
      <ScrollView Grid.Row="0"
                  InputTransparent="{Binding IsConfirming}">
        <VerticalStackLayout Spacing="16" Padding="20" WidthRequest="360"
                             IsEnabled="{Binding IsConfirming, Converter={StaticResource InverseBoolConverter}}">
      <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8">
        <Button Text="←"
                WidthRequest="32"
                HeightRequest="32"
                Padding="0"
                TextColor="{AppThemeBinding Light=Black, Dark=White}"
                BackgroundColor="Transparent"
                IsVisible="{Binding ShowBackButton}"
                Clicked="BackButton_Clicked"/>
        <VerticalStackLayout Grid.Column="1"
                             Spacing="4">
          <Label Text="{Binding Title}"
                 FontAttributes="Bold"
                 FontSize="20"
                 LineBreakMode="TailTruncation"/>
          <Label Text="{Binding Subtitle}"
                 FontSize="13"
                 TextColor="{AppThemeBinding Light=#777, Dark=#AAA}"
                 LineBreakMode="TailTruncation"
                 MaxLines="2"
                 IsVisible="{Binding HasSubtitle}"/>
        </VerticalStackLayout>
        <Button Grid.Column="2"
                Text="✕"
                FontSize="16"
                WidthRequest="32"
                HeightRequest="32"
                Padding="0"
                BackgroundColor="Transparent"
                Clicked="CloseButton_Clicked"/>
      </Grid>

      <Label Text="{Binding Description}"
             FontSize="13"
             TextColor="{AppThemeBinding Light=#666, Dark=#A0A0A0}"
             IsVisible="{Binding HasDescription}"
             LineBreakMode="WordWrap"/>

      <VerticalStackLayout Spacing="8"
                           IsVisible="{Binding HasVariants}">
        <Label Text="Presentación"
               FontAttributes="Bold"
               FontSize="14"/>
        <CollectionView ItemsSource="{Binding Variants}"
                        SelectionMode="Single"
                        SelectedItem="{Binding SelectedVariant}">
          <CollectionView.ItemsLayout>
            <LinearItemsLayout Orientation="Vertical" ItemSpacing="8"/>
          </CollectionView.ItemsLayout>
          <CollectionView.ItemTemplate>
            <DataTemplate>
              <Border StrokeThickness="1"
                      Stroke="{AppThemeBinding Light=#E0E0E0, Dark=#333}"
                      BackgroundColor="{Binding BackgroundColor}"
                      StrokeShape="{RoundRectangle CornerRadius=12}">
                <Grid ColumnDefinitions="*,Auto"
                      Padding="14,12">
                  <VerticalStackLayout Spacing="2">
                    <Label Text="{Binding DisplayName}"
                           FontAttributes="Bold"
                           LineBreakMode="TailTruncation"/>
                    <Label Text="{Binding Description}"
                           FontSize="12"
                           TextColor="{AppThemeBinding Light=#777, Dark=#AAA}"
                           IsVisible="{Binding HasDescription}"
                           LineBreakMode="TailTruncation"
                           MaxLines="2"/>
                  </VerticalStackLayout>
                  <Label Grid.Column="1"
                         Text="{Binding PriceLabel}"
                         FontAttributes="Bold"
                         VerticalOptions="Center"/>
                </Grid>
              </Border>
            </DataTemplate>
          </CollectionView.ItemTemplate>
        </CollectionView>
      </VerticalStackLayout>

      <VerticalStackLayout Spacing="8"
                           IsVisible="{Binding HasComboChildren}">
        <Label Text="Contenido del combo"
               FontAttributes="Bold"
               FontSize="14"/>
        <VerticalStackLayout BindableLayout.ItemsSource="{Binding ComboChildren}"
                             Spacing="8">
          <BindableLayout.ItemTemplate>
            <DataTemplate>
              <Border StrokeThickness="1"
                      Stroke="{AppThemeBinding Light=#E0E0E0, Dark=#444}"
                      BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1E1A1F}"
                      StrokeShape="{RoundRectangle CornerRadius=12}"
                      Padding="12"
                      Margin="0,2">
                <VerticalStackLayout Spacing="10">
                  <Grid ColumnDefinitions="Auto,*"
                        ColumnSpacing="12">
                    <CheckBox IsChecked="{Binding IsSelected}"
                              IsEnabled="{Binding CanToggle}"
                              VerticalOptions="Center"/>
                    <VerticalStackLayout Grid.Column="1"
                                         Spacing="2">
                      <Label Text="{Binding DisplayName}"
                             FontAttributes="Bold"/>
                      <Label Text="{Binding HeaderDetail}"
                             FontSize="12"
                             TextColor="{AppThemeBinding Light=#777, Dark=#AAA}"
                             IsVisible="{Binding HasHeaderDetail}"/>
                      <Label Text="{Binding VariantSummary}"
                             FontSize="12"
                             TextColor="{AppThemeBinding Light=#884166, Dark=#F2CCE4}"
                             IsVisible="{Binding HasVariantSummary}"/>
                    </VerticalStackLayout>
                  </Grid>

                  <VerticalStackLayout Spacing="8"
                                       IsVisible="{Binding HasVariants}">
                    <Label Text="Presentación"
                           FontAttributes="Bold"
                           FontSize="13"/>
                    <CollectionView ItemsSource="{Binding Variants}"
                                    SelectionMode="Single"
                                    SelectedItem="{Binding SelectedVariant}">
                      <CollectionView.ItemsLayout>
                        <LinearItemsLayout Orientation="Vertical" ItemSpacing="8"/>
                      </CollectionView.ItemsLayout>
                      <CollectionView.ItemTemplate>
                        <DataTemplate>
                          <Border StrokeThickness="1"
                                  Stroke="{AppThemeBinding Light=#E0E0E0, Dark=#333}"
                                  BackgroundColor="{Binding BackgroundColor}"
                                  StrokeShape="{RoundRectangle CornerRadius=12}">
                            <Grid ColumnDefinitions="*,Auto"
                                  Padding="12,10">
                              <VerticalStackLayout Spacing="2">
                                <Label Text="{Binding DisplayName}"
                                       FontAttributes="Bold"
                                       LineBreakMode="TailTruncation"/>
                                <Label Text="{Binding Description}"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light=#777, Dark=#AAA}"
                                       IsVisible="{Binding HasDescription}"
                                       LineBreakMode="TailTruncation"/>
                              </VerticalStackLayout>
                              <Label Grid.Column="1"
                                     Text="{Binding PriceLabel}"
                                     FontAttributes="Bold"
                                     VerticalOptions="Center"/>
                            </Grid>
                          </Border>
                        </DataTemplate>
                      </CollectionView.ItemTemplate>
                    </CollectionView>
                  </VerticalStackLayout>

                  <CollectionView ItemsSource="{Binding ModifierGroups}"
                                  SelectionMode="None"
                                  IsVisible="{Binding HasModifiers}">
                    <CollectionView.ItemTemplate>
                      <DataTemplate>
                        <Border StrokeThickness="1"
                                Stroke="{AppThemeBinding Light=#E7E0E5, Dark=#333}"
                                StrokeShape="{RoundRectangle CornerRadius=16}"
                                Padding="12"
                                Margin="0,4">
                          <VerticalStackLayout Spacing="10">
                            <Grid ColumnDefinitions="*,Auto,Auto"
                                  ColumnSpacing="8"
                                  VerticalOptions="Center">
                              <Label Text="{Binding Name}"
                                     FontAttributes="Bold"
                                     FontSize="14"/>
                              <Label Grid.Column="1"
                                     Text="{Binding RequirementText}"
                                     FontSize="12"
                                     TextColor="{AppThemeBinding Light=#884166, Dark=#D0A0B8}"
                                     HorizontalOptions="End"
                                     VerticalOptions="Center"/>
                              <Button Grid.Column="2"
                                      Text="{Binding IsExpanded, Converter={StaticResource BoolToIconConverter}}"
                                      Command="{Binding ToggleExpandedCommand}"
                                      WidthRequest="28"
                                      HeightRequest="28"
                                      Padding="0"
                                      BackgroundColor="Transparent"
                                      FontSize="16"
                                      TextColor="{AppThemeBinding Light=#884166, Dark=#F2CCE4}"/>
                            </Grid>

                            <VerticalStackLayout Spacing="8"
                                                 IsVisible="{Binding IsExpanded}"
                                                 BindableLayout.ItemsSource="{Binding Options}">
                              <BindableLayout.ItemTemplate>
                                <DataTemplate>
                                  <Border StrokeThickness="1"
                                          Stroke="{AppThemeBinding Light=#E0E0E0, Dark=#444}"
                                          BackgroundColor="{Binding Background}"
                                          StrokeShape="{RoundRectangle CornerRadius=12}"
                                          Padding="12"
                                          Margin="0,2">
                                    <Grid ColumnDefinitions="*,Auto"
                                          ColumnSpacing="12">
                          <VerticalStackLayout Spacing="2">
                            <Label Text="{Binding Name}"
                                   FontAttributes="Bold"
                                   LineBreakMode="WordWrap"
                                   MaxLines="3"/>
                            <Label Text="{Binding Description}"
                                   IsVisible="{Binding HasDescription}"
                                   FontSize="12"
                                   TextColor="{AppThemeBinding Light=#777, Dark=#AAA}"/>
                                        <Label Text="{Binding ExtraLabel}"
                                               FontSize="12"
                                               TextColor="{AppThemeBinding Light=#884166, Dark=#D0A0B8}">
                                          <Label.Triggers>
                                            <DataTrigger TargetType="Label" Binding="{Binding ExtraLabel}" Value="">
                                              <Setter Property="IsVisible" Value="False"/>
                                            </DataTrigger>
                                          </Label.Triggers>
                                        </Label>
                                      </VerticalStackLayout>

                                      <HorizontalStackLayout Grid.Column="1"
                                                             Spacing="6"
                                                             VerticalOptions="Center">
                                        <Button Text="−"
                                                WidthRequest="32"
                                                HeightRequest="32"
                                                CornerRadius="16"
                                                Command="{Binding DecrementCommand}"
                                                IsEnabled="{Binding CanDecrement}"/>
                                        <Frame WidthRequest="32"
                                               HeightRequest="32"
                                               CornerRadius="16"
                                               Padding="0"
                                               HasShadow="False"
                                               BackgroundColor="{AppThemeBinding Light=#894164, Dark=#894164}"
                                               VerticalOptions="Center"
                                               HorizontalOptions="Center">
                                          <Label Text="{Binding QuantityDisplay}"
                                                 HorizontalOptions="Center"
                                                 VerticalOptions="Center"
                                                 TextColor="White"
                                                 FontAttributes="Bold"/>
                                        </Frame>
                                        <Button Text="+"
                                                WidthRequest="32"
                                                HeightRequest="32"
                                                CornerRadius="16"
                                                Command="{Binding IncrementCommand}"
                                                IsEnabled="{Binding CanIncrement}"/>
                                      </HorizontalStackLayout>
                                    </Grid>
                                  </Border>
                                </DataTemplate>
                              </BindableLayout.ItemTemplate>
                            </VerticalStackLayout>
                          </VerticalStackLayout>
                        </Border>
                      </DataTemplate>
                    </CollectionView.ItemTemplate>
                  </CollectionView>
                </VerticalStackLayout>
              </Border>
            </DataTemplate>
          </BindableLayout.ItemTemplate>
        </VerticalStackLayout>
      </VerticalStackLayout>

                    <CollectionView ItemsSource="{Binding ModifierGroups}"
                                  SelectionMode="None"
                                  IsVisible="{Binding HasModifiers}">
                    <CollectionView.ItemTemplate>
                      <DataTemplate>
                        <Border StrokeThickness="1"
                                Stroke="{AppThemeBinding Light=#E7E0E5, Dark=#333}"
                                StrokeShape="{RoundRectangle CornerRadius=16}"
                                Padding="16"
                                Margin="0,6">
              <VerticalStackLayout Spacing="12">
                <Grid ColumnDefinitions="*,Auto,Auto"
                      ColumnSpacing="8"
                      VerticalOptions="Center">
                  <Label Text="{Binding Name}"
                         FontAttributes="Bold"
                         FontSize="15"/>
                  <Label Grid.Column="1"
                         Text="{Binding RequirementText}"
                         FontSize="12"
                         TextColor="{AppThemeBinding Light=#884166, Dark=#D0A0B8}"
                         HorizontalOptions="End"
                         VerticalOptions="Center"/>
                  <Button Grid.Column="2"
                          Text="{Binding IsExpanded, Converter={StaticResource BoolToIconConverter}}"
                          Command="{Binding ToggleExpandedCommand}"
                          WidthRequest="32"
                          HeightRequest="32"
                          Padding="0"
                          BackgroundColor="Transparent"
                          FontSize="16"
                          TextColor="{AppThemeBinding Light=#884166, Dark=#F2CCE4}"/>
                </Grid>

                <VerticalStackLayout Spacing="8"
                                     IsVisible="{Binding IsExpanded}"
                                     BindableLayout.ItemsSource="{Binding Options}">
                  <BindableLayout.ItemTemplate>
                    <DataTemplate>
                      <Border StrokeThickness="1"
                              Stroke="{AppThemeBinding Light=#E0E0E0, Dark=#444}"
                              BackgroundColor="{Binding Background}"
                              StrokeShape="{RoundRectangle CornerRadius=12}"
                              Padding="12"
                              Margin="0,2">
                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                          <VerticalStackLayout Spacing="2">
                              <Label Text="{Binding Name}"
                                     FontAttributes="Bold"
                                     LineBreakMode="WordWrap"
                                     MaxLines="3"/>
                              <Label Text="{Binding Description}"
                                     IsVisible="{Binding HasDescription}"
                                     FontSize="12"
                                     TextColor="{AppThemeBinding Light=#777, Dark=#AAA}"/>
                            <Label Text="{Binding ExtraLabel}"
                                   FontSize="12"
                                   TextColor="{AppThemeBinding Light=#884166, Dark=#D0A0B8}">
                              <Label.Triggers>
                                <DataTrigger TargetType="Label" Binding="{Binding ExtraLabel}" Value="">
                                  <Setter Property="IsVisible" Value="False"/>
                                </DataTrigger>
                              </Label.Triggers>
                            </Label>
                          </VerticalStackLayout>

                          <HorizontalStackLayout Grid.Column="1"
                                                 Spacing="6"
                                                 VerticalOptions="Center">
                            <Button Text="−"
                                    WidthRequest="32"
                                    HeightRequest="32"
                                    CornerRadius="16"
                                    Command="{Binding DecrementCommand}"
                                    IsEnabled="{Binding CanDecrement}"/>
                            <Frame WidthRequest="32"
                                   HeightRequest="32"
                                   CornerRadius="16"
                                   Padding="0"
                                   HasShadow="False"
                                   BackgroundColor="{AppThemeBinding Light=#894164, Dark=#894164}"
                                   VerticalOptions="Center"
                                   HorizontalOptions="Center">
                              <Label Text="{Binding QuantityDisplay}"
                                     HorizontalOptions="Center"
                                     VerticalOptions="Center"
                                     TextColor="White"
                                     FontAttributes="Bold"/>
                            </Frame>
                            <Button Text="+"
                                    WidthRequest="32"
                                    HeightRequest="32"
                                    CornerRadius="16"
                                    Command="{Binding IncrementCommand}"
                                    IsEnabled="{Binding CanIncrement}"/>
                          </HorizontalStackLayout>
                        </Grid>
                      </Border>
                    </DataTemplate>
                  </BindableLayout.ItemTemplate>
                </VerticalStackLayout>
              </VerticalStackLayout>
            </Border>
          </DataTemplate>
        </CollectionView.ItemTemplate>
      </CollectionView>

      <Grid ColumnDefinitions="Auto,Auto,*,Auto"
            Padding="0,8,0,0">
        <Label Text="Cantidad"
               FontAttributes="Bold"
               VerticalOptions="Center"/>
        <Border Grid.Column="1"
                WidthRequest="44"
                HeightRequest="34"
                Stroke="{AppThemeBinding Light=#E0C7D6, Dark=#3A2532}"
                BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1E1A1F}"
                StrokeShape="{RoundRectangle CornerRadius=8}"
                HorizontalOptions="Start"
                VerticalOptions="Center">
          <Label Text="{Binding Quantity}"
                 HorizontalTextAlignment="Center"
                 VerticalTextAlignment="Center"
                 FontAttributes="Bold"/>
        </Border>
        <Stepper Grid.Column="2"
                 Minimum="1"
                 Maximum="50"
                 Increment="1"
                 IsEnabled="{Binding IsQuantityEditable}"
                 Value="{Binding Quantity}"
                 WidthRequest="150"
                 HeightRequest="34"/>
      </Grid>

      <VerticalStackLayout>
        <Label Text="Notas opcionales"
               FontSize="13"/>
        <Editor Text="{Binding Notes}"
                AutoSize="TextChanges"
                Placeholder="Ej. Sin picante"/>
      </VerticalStackLayout>

      <Label Text="{Binding ValidationMessage}"
             TextColor="#E53935"
             FontSize="12"
             IsVisible="{Binding HasValidationMessage}"/>

      <Grid ColumnDefinitions="*,*"
            ColumnSpacing="12"
            Padding="0,8,0,0">
        <Button Text="Cancelar"
                Command="{Binding CancelCommand}"
                BackgroundColor="{AppThemeBinding Light=#F1E9F1, Dark=#2B1D29}"
                TextColor="{AppThemeBinding Light=#894164, Dark=#D5B2C2}"/>
        <Button Grid.Column="1"
                Text="{Binding ConfirmButtonText}"
                Command="{Binding ConfirmCommand}"
                BackgroundColor="#894164"
                TextColor="White"
                IsEnabled="{Binding IsConfirming, Converter={StaticResource InverseBoolConverter}}"/>
      </Grid>
      </VerticalStackLayout>
      </ScrollView>
      <Grid Grid.Row="0"
            IsVisible="{Binding IsConfirming}"
            BackgroundColor="#80000000"
            InputTransparent="False"
            VerticalOptions="FillAndExpand"
            HorizontalOptions="FillAndExpand"
            ZIndex="1000">
        <ActivityIndicator IsRunning="True"
                           Color="White"
                           VerticalOptions="Center"
                           HorizontalOptions="Center"
                           WidthRequest="48"
                           HeightRequest="48"/>
      </Grid>
    </Grid>
  </Border>
</toolkit:Popup>

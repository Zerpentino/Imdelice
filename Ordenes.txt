
Contrato del mÃ³dulo de pedidos (API)
0. Notas generales
	â€¢	Todas las respuestas usan wrapper estÃ¡ndar:{ error, data, message }
	â€¢	Todas las rutas estÃ¡n protegidas con permisos:
	â€¢	orders.read
	â€¢	orders.create
	â€¢	orders.update
	â€¢	El controlador usa AuthRequest, asyncHandler y no usa console.log.
	â€¢	Siempre que se toca un pedido se recalculan totales ignorando Ã­tems cancelados.

1. Listar pedidos
GET /api/ordersPermiso: orders.read
Query params (todos opcionales)
	â€¢	statuses: CSV de estados, ej. OPEN,HOLD
	â€¢	serviceType: DINE_IN | TAKEAWAY | DELIVERY
	â€¢	source: POS | UBER | DIDI | RAPPI
	â€¢	from / to: fechas ISO; to se expande al final del dÃ­a
	â€¢	tableId: entero
Respuesta (data[])
Para cada pedido:
	â€¢	id
	â€¢	code
	â€¢	status: DRAFT | OPEN | HOLD | CLOSED | CANCELED
	â€¢	serviceType: sala / llevar / delivery
	â€¢	source: canal (POS, UBER, etc.)
	â€¢	Montos (en centavos):
	â€¢	subtotalCents
	â€¢	discountCents
	â€¢	serviceFeeCents
	â€¢	taxCents
	â€¢	totalCents
	â€¢	paymentsTotalCents
	â€¢	paymentsTipCents
	â€¢	Timestamps clave:
	â€¢	openedAt
	â€¢	acceptedAt
	â€¢	readyAt
	â€¢	servedAt
	â€¢	closedAt
	â€¢	canceledAt
	â€¢	prepEtaMinutes (nullable)
	â€¢	externalRef
	â€¢	table: { id, name } si hay mesa
	â€¢	payments[]: id, method, amountCents, tipCents, paidAt, note
Esta lÃ³gica estÃ¡ en PrismaOrderRepository.list + OrdersController.list.
Ejemplo
{
    "error": null,
    "data": [
        {
            "id": 2,
            "code": "IM-251030-H8AX",
            "status": "OPEN",
            "serviceType": "DELIVERY",
            "source": "POS",
            "subtotalCents": 0,
            "discountCents": 0,
            "serviceFeeCents": 0,
            "taxCents": 0,
            "totalCents": 0,
            "paymentsTotalCents": 0,
            "paymentsTipCents": 0,
            "openedAt": "2025-10-30T17:12:45.060Z",
            "closedAt": null,
            "acceptedAt": "2025-10-30T17:12:45.059Z",
            "readyAt": null,
            "servedAt": null,
            "canceledAt": null,
            "prepEtaMinutes": 18,
            "externalRef": "UBER-ORD-99321",
            "table": {
                "id": 1,
                "name": "Mesa 1 (actualizada)"
            },
            "payments": []
        },
        {
            "id": 1,
            "code": "IM-251030-LR97",
            "status": "OPEN",
            "serviceType": "DINE_IN",
            "source": "POS",
            "subtotalCents": 0,
            "discountCents": 0,
            "serviceFeeCents": 0,
            "taxCents": 0,
            "totalCents": 0,
            "paymentsTotalCents": 0,
            "paymentsTipCents": 0,
            "openedAt": "2025-10-30T17:08:53.722Z",
            "closedAt": null,
            "acceptedAt": "2025-10-30T17:08:53.719Z",
            "readyAt": null,
            "servedAt": null,
            "canceledAt": null,
            "prepEtaMinutes": 18,
            "externalRef": "UBER-ORD-99321",
            "table": {
                "id": 1,
                "name": "Mesa 1 (actualizada)"
            },
            "payments": []
        }
    ],
    "message": "OK"
}
Estructura que sale del repo (ya la vi): cada pedido trae mÃ¡s o menos esto:

{
  "id": 45,
  "code": "A-2025-000045",
  "status": "OPEN",
  "serviceType": "DINE_IN",
  "source": "POS",
  "subtotalCents": 13000,
  "discountCents": 0,
  "serviceFeeCents": 0,
  "taxCents": 0,
  "totalCents": 13000,
  "paymentsTotalCents": 0,
  "paymentsTipCents": 0,
  "openedAt": "2025-10-30T17:05:14.000Z",
  "closedAt": null,
  "acceptedAt": null,
  "readyAt": null,
  "servedAt": null,
  "canceledAt": null,
  "prepEtaMinutes": null,
  "externalRef": null,
  "table": { "id": 3, "name": "M3" },
  "payments": [
    {
      "id": 1,
      "method": "CASH",
      "amountCents": 13000,
      "tipCents": 0,
      "paidAt": "2025-10-30T17:10:00.000Z",
      "note": null
    }
  ]
}
Ojo: en este listado NO vienen los items[]. Para eso es el GET /api/orders/:id.
Te dejo los casos completos para que el front no se pierda ğŸ‘‡

Caso 1 â€“ sin filtros (lista general)
Request

GET {{baseUrl}}/api/orders
Authorization: Bearer {{token}}
Response

{
  "error": null,
  "data": [
    {
      "id": 71,
      "code": "A-2025-000071",
      "status": "OPEN",
      "serviceType": "DINE_IN",
      "source": "POS",
      "subtotalCents": 18500,
      "discountCents": 0,
      "serviceFeeCents": 0,
      "taxCents": 0,
      "totalCents": 18500,
      "paymentsTotalCents": 0,
      "paymentsTipCents": 0,
      "openedAt": "2025-10-30T17:32:00.000Z",
      "closedAt": null,
      "acceptedAt": null,
      "readyAt": null,
      "servedAt": null,
      "canceledAt": null,
      "prepEtaMinutes": null,
      "externalRef": null,
      "table": { "id": 2, "name": "M2" },
      "payments": []
    },
    {
      "id": 70,
      "code": "A-2025-000070",
      "status": "CLOSED",
      "serviceType": "DINE_IN",
      "source": "POS",
      "subtotalCents": 23000,
      "discountCents": 0,
      "serviceFeeCents": 0,
      "taxCents": 0,
      "totalCents": 23000,
      "paymentsTotalCents": 23000,
      "paymentsTipCents": 0,
      "openedAt": "2025-10-30T16:55:00.000Z",
      "closedAt": "2025-10-30T17:25:00.000Z",
      "acceptedAt": "2025-10-30T17:00:00.000Z",
      "readyAt": "2025-10-30T17:10:00.000Z",
      "servedAt": "2025-10-30T17:15:00.000Z",
      "canceledAt": null,
      "prepEtaMinutes": null,
      "externalRef": null,
      "table": { "id": 4, "name": "M4" },
      "payments": [
        {
          "id": 10,
          "method": "CASH",
          "amountCents": 20000,
          "tipCents": 0,
          "paidAt": "2025-10-30T17:23:00.000Z",
          "note": null
        },
        {
          "id": 11,
          "method": "CARD",
          "amountCents": 3000,
          "tipCents": 0,
          "paidAt": "2025-10-30T17:24:00.000Z",
          "note": "Resto en tarjeta"
        }
      ]
    },
    {
      "id": 61,
      "code": "DLV-2025-000061",
      "status": "OPEN",
      "serviceType": "DELIVERY",
      "source": "UBER",
      "subtotalCents": 8500,
      "discountCents": 0,
      "serviceFeeCents": 0,
      "taxCents": 0,
      "totalCents": 8500,
      "paymentsTotalCents": 0,
      "paymentsTipCents": 0,
      "openedAt": "2025-10-30T17:20:00.000Z",
      "closedAt": null,
      "acceptedAt": null,
      "readyAt": null,
      "servedAt": null,
      "canceledAt": null,
      "prepEtaMinutes": 25,
      "externalRef": "UBER#12345",
      "table": null,
      "payments": []
    }
  ],
  "message": "OK"
}
QuÃ© ve el front:
	â€¢	mezcla de DINE_IN y DELIVERY
	â€¢	algunos tienen mesa, otros no
	â€¢	algunos ya tienen pagos
	â€¢	vienen ordenados por openedAt desc

Caso 2 â€“ filtrar por estado
El DTO acepta statuses como CSV.
Request

GET {{baseUrl}}/api/orders?statuses=OPEN,HOLD
Authorization: Bearer {{token}}
Response (ejemplo)

{
  "error": null,
  "data": [
    {
      "id": 71,
      "code": "A-2025-000071",
      "status": "OPEN",
      "serviceType": "DINE_IN",
      "source": "POS",
      "subtotalCents": 18500,
      "discountCents": 0,
      "serviceFeeCents": 0,
      "taxCents": 0,
      "totalCents": 18500,
      "paymentsTotalCents": 0,
      "paymentsTipCents": 0,
      "openedAt": "2025-10-30T17:32:00.000Z",
      "closedAt": null,
      "table": { "id": 2, "name": "M2" },
      "payments": []
    },
    {
      "id": 61,
      "code": "DLV-2025-000061",
      "status": "OPEN",
      "serviceType": "DELIVERY",
      "source": "UBER",
      "subtotalCents": 8500,
      "discountCents": 0,
      "serviceFeeCents": 0,
      "taxCents": 0,
      "totalCents": 8500,
      "paymentsTotalCents": 0,
      "paymentsTipCents": 0,
      "openedAt": "2025-10-30T17:20:00.000Z",
      "closedAt": null,
      "table": null,
      "payments": []
    }
  ],
  "message": "OK"
}

Caso 3 â€“ solo los de restaurante (DINE_IN)
Request

GET {{baseUrl}}/api/orders?serviceType=DINE_IN
Response

{
  "error": null,
  "data": [
    {
      "id": 71,
      "code": "A-2025-000071",
      "status": "OPEN",
      "serviceType": "DINE_IN",
      "source": "POS",
      "subtotalCents": 18500,
      "discountCents": 0,
      "serviceFeeCents": 0,
      "taxCents": 0,
      "totalCents": 18500,
      "paymentsTotalCents": 0,
      "paymentsTipCents": 0,
      "openedAt": "2025-10-30T17:32:00.000Z",
      "closedAt": null,
      "table": { "id": 2, "name": "M2" },
      "payments": []
    },
    {
      "id": 70,
      "code": "A-2025-000070",
      "status": "CLOSED",
      "serviceType": "DINE_IN",
      "source": "POS",
      "subtotalCents": 23000,
      "discountCents": 0,
      "serviceFeeCents": 0,
      "taxCents": 0,
      "totalCents": 23000,
      "paymentsTotalCents": 23000,
      "paymentsTipCents": 0,
      "openedAt": "2025-10-30T16:55:00.000Z",
      "closedAt": "2025-10-30T17:25:00.000Z",
      "table": { "id": 4, "name": "M4" },
      "payments": [
        { "id": 10, "method": "CASH", "amountCents": 20000, "tipCents": 0, "paidAt": "2025-10-30T17:23:00.000Z", "note": null },
        { "id": 11, "method": "CARD", "amountCents": 3000, "tipCents": 0, "paidAt": "2025-10-30T17:24:00.000Z", "note": "Resto en tarjeta" }
      ]
    }
  ],
  "message": "OK"
}

Caso 4 â€“ solo los de una mesa
El controller hace tableId numÃ©rico.
Request

GET {{baseUrl}}/api/orders?tableId=2&statuses=OPEN
Response

{
  "error": null,
  "data": [
    {
      "id": 71,
      "code": "A-2025-000071",
      "status": "OPEN",
      "serviceType": "DINE_IN",
      "source": "POS",
      "subtotalCents": 18500,
      "discountCents": 0,
      "serviceFeeCents": 0,
      "taxCents": 0,
      "totalCents": 18500,
      "paymentsTotalCents": 0,
      "paymentsTipCents": 0,
      "openedAt": "2025-10-30T17:32:00.000Z",
      "closedAt": null,
      "table": { "id": 2, "name": "M2" },
      "payments": []
    }
  ],
  "message": "OK"
}
Esto le sirve al front para â€œver quÃ© tiene la mesa 2â€.

Caso 5 â€“ por origen (source=UBER, DIDI, RAPPIâ€¦)
El DTO transforma array a â€œprimer valorâ€, asÃ­ que con uno basta.
Request

GET {{baseUrl}}/api/orders?source=UBER
Response

{
  "error": null,
  "data": [
    {
      "id": 61,
      "code": "DLV-2025-000061",
      "status": "OPEN",
      "serviceType": "DELIVERY",
      "source": "UBER",
      "subtotalCents": 8500,
      "discountCents": 0,
      "serviceFeeCents": 0,
      "taxCents": 0,
      "totalCents": 8500,
      "paymentsTotalCents": 0,
      "paymentsTipCents": 0,
      "openedAt": "2025-10-30T17:20:00.000Z",
      "closedAt": null,
      "table": null,
      "payments": []
    }
  ],
  "message": "OK"
}


Caso 7 â€“ por fecha (from / to)
El controller hace:
	â€¢	from â†’ openedAt >= from
	â€¢	to â†’ openedAt <= to (fin de dÃ­a)
Request

GET {{baseUrl}}/api/orders?from=2025-10-30&to=2025-10-30
Response (resumen)

{
  "error": null,
  "data": [
    { "id": 71, "code": "A-2025-000071", "status": "OPEN", "serviceType": "DINE_IN", "source": "POS", "subtotalCents": 18500, "totalCents": 18500, "openedAt": "2025-10-30T17:32:00.000Z", "table": { "id": 2, "name": "M2" }, "payments": [] },
    { "id": 70, "code": "A-2025-000070", "status": "CLOSED", "serviceType": "DINE_IN", "source": "POS", "subtotalCents": 23000, "totalCents": 23000, "openedAt": "2025-10-30T16:55:00.000Z", "table": { "id": 4, "name": "M4" }, "payments": [ /* ... */ ] },
    { "id": 61, "code": "DLV-2025-000061", "status": "OPEN", "serviceType": "DELIVERY", "source": "UBER", "subtotalCents": 8500, "totalCents": 8500, "openedAt": "2025-10-30T17:20:00.000Z", "table": null, "payments": [] }
  ],
  "message": "OK"
}

2. Obtener un pedido
GET /api/orders/:idPermiso: orders.read
Devuelve el ticket completo:
	â€¢	datos del pedido
	â€¢	Ã­tems (producto, variante, modifiers, combos hijos)
	â€¢	pagos
	â€¢	mesa
Ejemplos casos:{
    "error": null,
    "data": {
        "id": 2,
        "code": "IM-251030-H8AX",
        "status": "OPEN",
        "serviceType": "DELIVERY",
        "source": "POS",
        "externalRef": "UBER-ORD-99321",
        "prepEtaMinutes": 18,
        "tableId": 1,
        "openedAt": "2025-10-30T17:12:45.060Z",
        "acceptedAt": "2025-10-30T17:12:45.059Z",
        "readyAt": null,
        "servedAt": null,
        "closedAt": null,
        "canceledAt": null,
        "note": "Sin jitomate en la baguette",
        "customerName": null,
        "customerPhone": null,
        "covers": 3,
        "servedByUserId": 1,
        "subtotalCents": 15400,
        "discountCents": 0,
        "serviceFeeCents": 0,
        "taxCents": 0,
        "totalCents": 15400,
        "items": [
            {
                "id": 1,
                "orderId": 2,
                "productId": 18,
                "variantId": null,
                "parentItemId": null,
                "quantity": 2,
                "status": "NEW",
                "basePriceCents": 7700,
                "extrasTotalCents": 0,
                "totalPriceCents": 15400,
                "nameSnapshot": "Marquesita Champi",
                "variantNameSnapshot": null,
                "notes": "Mesa 4, lo quiere rÃ¡pido",
                "variant": null,
                "product": {
                    "id": 18,
                    "name": "Marquesita Champi",
                    "type": "SIMPLE"
                },
                "modifiers": [
                    {
                        "id": 1,
                        "orderItemId": 1,
                        "optionId": 5,
                        "quantity": 1,
                        "priceExtraCents": 0,
                        "nameSnapshot": "PiÃ±a"
                    },
                    {
                        "id": 2,
                        "orderItemId": 1,
                        "optionId": 8,
                        "quantity": 1,
                        "priceExtraCents": 0,
                        "nameSnapshot": "Salsa de Pizza"
                    }
                ],
                "childItems": [],
                "parentItem": null
            }
        ],
        "payments": [],
        "table": {
            "id": 1,
            "name": "Mesa 1 (actualizada)",
            "seats": 6,
            "isActive": false
        }
    },
    "message": "OK"
}
Caso 1: pedido sencillo en mesa (DINE_IN), abierto, sin pagos
Request

GET http://localhost:3000/api/orders/45
Authorization: Bearer {{token}}
Response

{
  "error": null,
  "data": {
    "id": 45,
    "code": "A-2025-000045",
    "status": "OPEN",
    "serviceType": "DINE_IN",
    "source": "POS",
    "tableId": 3,
    "table": {
      "id": 3,
      "name": "M3",
      "seats": 4,
      "isActive": true
    },
    "openedAt": "2025-10-30T17:05:14.000Z",
    "acceptedAt": null,
    "readyAt": null,
    "servedAt": null,
    "closedAt": null,
    "canceledAt": null,
    "note": "Mesa de la entrada",
    "customerName": null,
    "customerPhone": null,
    "covers": 2,
    "subtotalCents": 13000,
    "discountCents": 0,
    "serviceFeeCents": 0,
    "taxCents": 0,
    "totalCents": 13000,
    "items": [
      {
        "id": 101,
        "orderId": 45,
        "productId": 12,
        "product": {
          "id": 12,
          "name": "Torta ahogada",
          "type": "SIMPLE"
        },
        "variantId": null,
        "variant": null,
        "parentItemId": null,
        "parentItem": null,
        "childItems": [],
        "quantity": 2,
        "status": "NEW",
        "basePriceCents": 6500,
        "extrasTotalCents": 0,
        "totalPriceCents": 13000,
        "nameSnapshot": "Torta ahogada",
        "variantNameSnapshot": null,
        "notes": "Con poquita salsa",
        "modifiers": []
      }
    ],
    "payments": []
  },
  "message": "OK"
}
QuÃ© aprende el front aquÃ­:
	â€¢	Si hay mesa â†’ viene table completo.
	â€¢	Si no hay pagos â†’ payments: [].
	â€¢	Los montos vienen en centavos.

Caso 2: pedido con combo (tiene hijos dentro de items)
AquÃ­ se ve lo que te pusieron: â€œÃ­tems (producto, variante, modifiers, combos hijos)â€.

{
  "error": null,
  "data": {
    "id": 50,
    "code": "A-2025-000050",
    "status": "OPEN",
    "serviceType": "DINE_IN",
    "source": "POS",
    "tableId": 1,
    "table": {
      "id": 1,
      "name": "M1",
      "seats": 4,
      "isActive": true
    },
    "openedAt": "2025-10-30T17:10:00.000Z",
    "note": null,
    "customerName": null,
    "customerPhone": null,
    "covers": 1,
    "subtotalCents": 12000,
    "discountCents": 0,
    "serviceFeeCents": 0,
    "taxCents": 0,
    "totalCents": 12000,
    "items": [
      {
        "id": 200,
        "orderId": 50,
        "productId": 30,
        "product": {
          "id": 30,
          "name": "Combo burger + papas",
          "type": "COMBO"
        },
        "variantId": null,
        "variant": null,
        "parentItemId": null,
        "parentItem": null,
        "quantity": 1,
        "status": "NEW",
        "basePriceCents": 12000,
        "extrasTotalCents": 0,
        "totalPriceCents": 12000,
        "nameSnapshot": "Combo burger + papas",
        "variantNameSnapshot": null,
        "notes": null,
        "modifiers": [],
        "childItems": [
          {
            "id": 201,
            "orderId": 50,
            "productId": 31,
            "product": {
              "id": 31,
              "name": "Hamburguesa sencilla",
              "type": "SIMPLE"
            },
            "variantId": null,
            "variant": null,
            "parentItemId": 200,
            "parentItem": { "id": 200 },
            "childItems": [],
            "quantity": 1,
            "status": "NEW",
            "basePriceCents": 0,
            "extrasTotalCents": 0,
            "totalPriceCents": 0,
            "nameSnapshot": "Hamburguesa sencilla",
            "variantNameSnapshot": null,
            "notes": null,
            "modifiers": []
          },
          {
            "id": 202,
            "orderId": 50,
            "productId": 32,
            "product": {
              "id": 32,
              "name": "Papas fritas",
              "type": "SIMPLE"
            },
            "variantId": null,
            "variant": null,
            "parentItemId": 200,
            "parentItem": { "id": 200 },
            "childItems": [],
            "quantity": 1,
            "status": "NEW",
            "basePriceCents": 0,
            "extrasTotalCents": 0,
            "totalPriceCents": 0,
            "nameSnapshot": "Papas fritas",
            "variantNameSnapshot": null,
            "notes": null,
            "modifiers": []
          }
        ]
      }
    ],
    "payments": []
  },
  "message": "OK"
}
Punto clave para el front: si item.product.type === "COMBO", revisa childItems para mostrarlos.
{
    "error": null,
    "data": {
        "id": 2,
        "code": "IM-251030-H8AX",
        "status": "OPEN",
        "serviceType": "DELIVERY",
        "source": "POS",
        "externalRef": "UBER-ORD-99321",
        "prepEtaMinutes": 18,
        "tableId": 1,
        "openedAt": "2025-10-30T17:12:45.060Z",
        "acceptedAt": "2025-10-30T17:12:45.059Z",
        "readyAt": null,
        "servedAt": null,
        "closedAt": null,
        "canceledAt": null,
        "note": "Sin jitomate en la baguette",
        "customerName": null,
        "customerPhone": null,
        "covers": 3,
        "servedByUserId": 1,
        "subtotalCents": 38600,
        "discountCents": 0,
        "serviceFeeCents": 0,
        "taxCents": 0,
        "totalCents": 38600,
        "items": [
            {
                "id": 1,
                "orderId": 2,
                "productId": 18,
                "variantId": null,
                "parentItemId": null,
                "quantity": 2,
                "status": "NEW",
                "basePriceCents": 7700,
                "extrasTotalCents": 0,
                "totalPriceCents": 15400,
                "nameSnapshot": "Marquesita Champi",
                "variantNameSnapshot": null,
                "notes": "Mesa 4, lo quiere rÃ¡pido",
                "variant": null,
                "product": {
                    "id": 18,
                    "name": "Marquesita Champi",
                    "type": "SIMPLE"
                },
                "modifiers": [
                    {
                        "id": 1,
                        "orderItemId": 1,
                        "optionId": 5,
                        "quantity": 1,
                        "priceExtraCents": 0,
                        "nameSnapshot": "PiÃ±a"
                    },
                    {
                        "id": 2,
                        "orderItemId": 1,
                        "optionId": 8,
                        "quantity": 1,
                        "priceExtraCents": 0,
                        "nameSnapshot": "Salsa de Pizza"
                    }
                ],
                "childItems": [],
                "parentItem": null
            },
            {
                "id": 2,
                "orderId": 2,
                "productId": 38,
                "variantId": null,
                "parentItemId": null,
                "quantity": 2,
                "status": "NEW",
                "basePriceCents": 11600,
                "extrasTotalCents": 0,
                "totalPriceCents": 23200,
                "nameSnapshot": "assas",
                "variantNameSnapshot": null,
                "notes": "Mesa 4, lo quiere rÃ¡pido",
                "variant": null,
                "product": {
                    "id": 38,
                    "name": "assas",
                    "type": "COMBO"
                },
                "modifiers": [
                    {
                        "id": 3,
                        "orderItemId": 2,
                        "optionId": 5,
                        "quantity": 1,
                        "priceExtraCents": 0,
                        "nameSnapshot": "PiÃ±a"
                    },
                    {
                        "id": 4,
                        "orderItemId": 2,
                        "optionId": 8,
                        "quantity": 1,
                        "priceExtraCents": 0,
                        "nameSnapshot": "Salsa de Pizza"
                    }
                ],
                "childItems": [
                    {
                        "id": 3,
                        "orderId": 2,
                        "productId": 28,
                        "variantId": null,
                        "parentItemId": 2,
                        "quantity": 2,
                        "status": "NEW",
                        "basePriceCents": 0,
                        "extrasTotalCents": 0,
                        "totalPriceCents": 0,
                        "nameSnapshot": "Crepas Saladas",
                        "variantNameSnapshot": null,
                        "notes": null
                    },
                    {
                        "id": 4,
                        "orderId": 2,
                        "productId": 35,
                        "variantId": null,
                        "parentItemId": 2,
                        "quantity": 2,
                        "status": "NEW",
                        "basePriceCents": 0,
                        "extrasTotalCents": 0,
                        "totalPriceCents": 0,
                        "nameSnapshot": "Cappuccino",
                        "variantNameSnapshot": null,
                        "notes": null
                    }
                ],
                "parentItem": null
            },
            {
                "id": 3,
                "orderId": 2,
                "productId": 28,
                "variantId": null,
                "parentItemId": 2,
                "quantity": 2,
                "status": "NEW",
                "basePriceCents": 0,
                "extrasTotalCents": 0,
                "totalPriceCents": 0,
                "nameSnapshot": "Crepas Saladas",
                "variantNameSnapshot": null,
                "notes": null,
                "variant": null,
                "product": {
                    "id": 28,
                    "name": "Crepas Saladas",
                    "type": "VARIANTED"
                },
                "modifiers": [],
                "childItems": [],
                "parentItem": {
                    "id": 2
                }
            },
            {
                "id": 4,
                "orderId": 2,
                "productId": 35,
                "variantId": null,
                "parentItemId": 2,
                "quantity": 2,
                "status": "NEW",
                "basePriceCents": 0,
                "extrasTotalCents": 0,
                "totalPriceCents": 0,
                "nameSnapshot": "Cappuccino",
                "variantNameSnapshot": null,
                "notes": null,
                "variant": null,
                "product": {
                    "id": 35,
                    "name": "Cappuccino",
                    "type": "VARIANTED"
                },
                "modifiers": [],
                "childItems": [],
                "parentItem": {
                    "id": 2
                }
            }
        ],
        "payments": [],
        "table": {
            "id": 1,
            "name": "Mesa 1 (actualizada)",
            "seats": 6,
            "isActive": false
        }
    },
    "message": "OK"
}

Caso 3: pedido de delivery (no mesa) con cliente

{
  "error": null,
  "data": {
    "id": 61,
    "code": "DLV-2025-000061",
    "status": "OPEN",
    "serviceType": "DELIVERY",
    "source": "UBER",
    "tableId": null,
    "table": null,
    "openedAt": "2025-10-30T17:20:00.000Z",
    "note": "Entregar en recepciÃ³n",
    "customerName": "Carlos Pacheco",
    "customerPhone": "3312345678",
    "covers": null,
    "subtotalCents": 8500,
    "discountCents": 0,
    "serviceFeeCents": 0,
    "taxCents": 0,
    "totalCents": 8500,
    "items": [
      {
        "id": 300,
        "orderId": 61,
        "productId": 40,
        "product": {
          "id": 40,
          "name": "Ensalada CÃ©sar",
          "type": "SIMPLE"
        },
        "variantId": 5,
        "variant": {
          "id": 5,
          "productId": 40,
          "name": "Grande",
          "priceCents": 8500
        },
        "parentItemId": null,
        "parentItem": null,
        "childItems": [],
        "quantity": 1,
        "status": "NEW",
        "basePriceCents": 8500,
        "extrasTotalCents": 0,
        "totalPriceCents": 8500,
        "nameSnapshot": "Ensalada CÃ©sar",
        "variantNameSnapshot": "Grande",
        "notes": "Aderezo aparte",
        "modifiers": []
      }
    ],
    "payments": []
  },
  "message": "OK"
}
AquÃ­ aprende el front: puede venir table: null y aun asÃ­ el pedido es vÃ¡lido, porque el serviceType es DELIVERY.

Caso 4: pedido cerrado con pagos

{
  "error": null,
  "data": {
    "id": 70,
    "code": "A-2025-000070",
    "status": "CLOSED",
    "serviceType": "DINE_IN",
    "source": "POS",
    "tableId": 4,
    "table": {
      "id": 4,
      "name": "M4",
      "seats": 6,
      "isActive": true
    },
    "openedAt": "2025-10-30T16:55:00.000Z",
    "acceptedAt": "2025-10-30T17:00:00.000Z",
    "readyAt": "2025-10-30T17:10:00.000Z",
    "servedAt": "2025-10-30T17:15:00.000Z",
    "closedAt": "2025-10-30T17:25:00.000Z",
    "note": null,
    "customerName": null,
    "customerPhone": null,
    "covers": 3,
    "subtotalCents": 23000,
    "discountCents": 0,
    "serviceFeeCents": 0,
    "taxCents": 0,
    "totalCents": 23000,
    "items": [
      {
        "id": 401,
        "orderId": 70,
        "productId": 50,
        "product": {
          "id": 50,
          "name": "Pasta Alfredo",
          "type": "SIMPLE"
        },
        "variantId": null,
        "variant": null,
        "parentItemId": null,
        "parentItem": null,
        "childItems": [],
        "quantity": 1,
        "status": "SERVED",
        "basePriceCents": 11000,
        "extrasTotalCents": 0,
        "totalPriceCents": 11000,
        "nameSnapshot": "Pasta Alfredo",
        "variantNameSnapshot": null,
        "notes": null,
        "modifiers": []
      },
      {
        "id": 402,
        "orderId": 70,
        "productId": 51,
        "product": {
          "id": 51,
          "name": "Limonada",
          "type": "SIMPLE"
        },
        "variantId": null,
        "variant": null,
        "parentItemId": null,
        "parentItem": null,
        "childItems": [],
        "quantity": 2,
        "status": "SERVED",
        "basePriceCents": 6000,
        "extrasTotalCents": 0,
        "totalPriceCents": 12000,
        "nameSnapshot": "Limonada",
        "variantNameSnapshot": null,
        "notes": null,
        "modifiers": []
      }
    ],
    "payments": [
      {
        "id": 10,
        "orderId": 70,
        "method": "CASH",
        "amountCents": 20000,
        "tipCents": 0,
        "paidAt": "2025-10-30T17:23:00.000Z",
        "receivedByUserId": null,
        "note": null
      },
      {
        "id": 11,
        "orderId": 70,
        "method": "CARD",
        "amountCents": 3000,
        "tipCents": 0,
        "paidAt": "2025-10-30T17:24:00.000Z",
        "receivedByUserId": null,
        "note": "Resto en tarjeta"
      }
    ]
  },
  "message": "OK"
}

3. Crear un pedido con items
POST /api/ordersPermiso: orders.createBody: validado con CreateOrderDto

Campos
	â€¢	Obligatorio: serviceType
	â€¢	Opcionales: source, tableId, note, covers, externalRef, prepEtaMinutes
	â€¢	status inicial: DRAFT | OPEN | HOLD
Si se crea en OPEN, se marca acceptedAt automÃ¡ticamente.
{
  "serviceType": "DINE_IN",               // obligatorio: DINE_IN | TAKEAWAY | DELIVERY

  "source": "POS",                        // opcional: POS | UBER | DIDI | RAPPI
  "tableId": 1,                          // opcional: si es consumo en mesa
  "covers": 3,                            // opcional: nÃºmero de comensales
  "note": "Sin cebolla en la hamburguesa",// opcional
  "externalRef": "UBER-ORD-99321",        // opcional: folio de plataforma si escojieron uber didi etc
  "prepEtaMinutes": 18,                   // opcional: ETA que ve el front/kiosko

  "status": "OPEN"                        // opcional: DRAFT | OPEN | HOLD
                                          // si no mandas, el backend puede asumir DRAFT
}

1.1. MÃ­nimo-mÃ­nimo (pos)

{
  "serviceType": "TAKEAWAY",
  "source": "POS"
}
Usa defaults:
	â€¢	status: OPEN
	â€¢	totales: 0
	â€¢	items: []

1.2. SalÃ³n (DINE_IN) con mesa

{
  "serviceType": "DINE_IN",
  "source": "POS",
  "tableId": 3,
  "covers": 2,
  "note": "Mesa de la entrada"
}

1.3. SalÃ³n (DINE_IN) sin mesa todavÃ­a

{
  "serviceType": "DINE_IN",
  "source": "POS",
  "covers": 4,
  "note": "AÃºn no asignan mesa"
}
Luego la mesa se pone con el PATCH de meta.

1.4. Para llevar (TAKEAWAY) con nombre

{
  "serviceType": "TAKEAWAY",
  "source": "POS",
  "customerName": "Cliente mostrador",
  "note": "Pasa en 20 min"
}

1.5. Delivery bÃ¡sico

{
  "serviceType": "DELIVERY",
  "source": "POS",
  "customerName": "Carlos",
  "customerPhone": "3312345678",
  "note": "Tocar antes de entrar"
}

1.6. Delivery de marketplace (UBER / DIDI / RAPPI)

{
  "serviceType": "DELIVERY",
  "source": "UBER",
  "customerName": "Carlos Pacheco",
  "customerPhone": "3312345678",
  "externalRef": "UBER#998877",
  "prepEtaMinutes": 25,
  "note": "Dejar en recepciÃ³n"
}

1.7. Crear pedido ya en HOLD
(para que no salga todavÃ­a en cocina / POS)

{
  "serviceType": "DINE_IN",
  "source": "POS",
  "status": "HOLD",
  "tableId": 2,
  "note": "Reservado, aÃºn no ordenan"
}

1.8. Crear pedido como DRAFT
(si tu Zod lo acepta igual que HOLD; algunos lo ponen asÃ­)

{
  "serviceType": "TAKEAWAY",
  "source": "POS",
  "status": "DRAFT",
  "customerName": "Prueba"
}

1.9. Crear pedido con 1 Ã­tem simple (unificado)

{
  "serviceType": "TAKEAWAY",
  "source": "POS",
  "items": [
    {
      "productId": 12
    }
  ]
}

1.10. Crear pedido con varios Ã­tems simples

{
  "serviceType": "DINE_IN",
  "source": "POS",
  "tableId": 5,
  "items": [
    { "productId": 12, "quantity": 2 },
    { "productId": 51 },
    { "productId": 18, "notes": "Sin cebolla" }
  ]
}
Permiso: orders.updateBody: AddOrderItemDto
	â€¢	Crea un renglÃ³n con producto, variante y modifiers.
	â€¢	Si es combo â†’ replica los hijos.
	â€¢	Devuelve { item } con snapshot (nombres, precios, estado).
	â€¢	Al final recalcula totales.
Ejemplos:
1. Caso mÃ¡s simple (un producto simple, sin nada extra)

{
  "productId": 12
}
	â€¢	El backend lo toma con quantity = 1.
	â€¢	Sirve para productos tipo SIMPLE.

2. Mismo producto pero con cantidad y nota

{
  "productId": 12,
  "quantity": 3,
  "notes": "Sin cebolla, porfa"
}
	â€¢	Ãštil para cocina / KDS, porque la nota viaja al renglon.

3. Producto con variantes (el backend en tu zip dice: â€œsi es VARIANTED y no mandas variantId, truenaâ€)

{
  "productId": 25,
  "variantId": 3,
  "quantity": 1
}
	â€¢	AquÃ­ el productId es el producto padre (ej. â€œPizzaâ€)
	â€¢	El variantId es la presentaciÃ³n (ej. â€œGrandeâ€, â€œMedianaâ€, â€œPepperoni grandeâ€).
	â€¢	Si no mandas variantId y ese producto es VARIANTED â†’ el repo te lanza: "variantId requerido para producto VARIANTED" (eso estÃ¡ en PrismaOrderRepository.ts).

4. Producto con modificadores (extras, toppings, salsasâ€¦)

{
  "productId": 18,
  "quantity": 2,
  "modifiers": [
    {
      "optionId": 7
    },
    {
      "optionId": 9,
      "quantity": 2
    }
  ]
}
	â€¢	Cada optionId debe existir en tus modifierOptions.
	â€¢	El backend busca esos optionId, suma el priceExtraCents y lo mete al renglÃ³n.
	â€¢	Si no encuentra alguno, lo ignora (no te truena la peticiÃ³n).

5. Producto con todo: variante + modificadores + nota

{
  "productId": 25,
  "variantId": 4,
  "quantity": 1,
  "notes": "Partir en 8",
  "modifiers": [
    { "optionId": 10 },           // extra queso
    { "optionId": 12, "quantity": 2 }  // 2 salsas
  ]
}

6. Combo (el repo detecta que es COMBO y crea los hijos solo)

{
  "productId": 30,
  "quantity": 1
}
	â€¢	En tu repo (PrismaOrderRepository) si el product.type === "COMBO" despuÃ©s de crear el Ã­tem crea los renglones hijos con los componentes del combo.
	â€¢	Por eso el front no tiene que mandar los hijos, solo el combo.

7. Ejemplo â€œdidÃ¡cticoâ€ con comentarios (para tu equipo)
Ojo: JSON real no lleva comentarios, esto es solo para que lo copien y lo limpien.

{
  "productId": 18,              // obligatorio
  "variantId": 2,                // opcional, si el producto lo requiere
  "quantity": 2,                 // default = 1
  "notes": "Mesa 4, lo quiere rÃ¡pido", // opcional
  "modifiers": [
    {
      "optionId": 5,             // ej. "Coca 600"
      "quantity": 1
    },
    {
      "optionId": 8,             // ej. "Sin gluten"
      "quantity": 1
    }
  ]
}


Respuesta :{
    "error": null,
    "data": {
        "item": {
            "id": 1,
            "orderId": 2,
            "productId": 18,
            "variantId": null,
            "parentItemId": null,
            "quantity": 2,
            "status": "NEW",
            "basePriceCents": 7700,
            "extrasTotalCents": 0,
            "totalPriceCents": 15400,
            "nameSnapshot": "Marquesita Champi",
            "variantNameSnapshot": null,
            "notes": "Mesa 4, lo quiere rÃ¡pido"
        }
    },
    "message": "Item added"
}

Respuesta: pedido creado (data con el pedido).
{
    "error": null,
    "data": {
        "id": 1,
        "code": "IM-251030-LR97",
        "status": "OPEN",
        "serviceType": "DINE_IN",
        "source": "POS",
        "externalRef": "UBER-ORD-99321",
        "prepEtaMinutes": 18,
        "tableId": 1,
        "openedAt": "2025-10-30T17:08:53.722Z",
        "acceptedAt": "2025-10-30T17:08:53.719Z",
        "readyAt": null,
        "servedAt": null,
        "closedAt": null,
        "canceledAt": null,
        "note": "Sin cebolla en la hamburguesa",
        "customerName": null,
        "customerPhone": null,
        "covers": 3,
        "servedByUserId": 1,
        "subtotalCents": 0,
        "discountCents": 0,
        "serviceFeeCents": 0,
        "taxCents": 0,
        "totalCents": 0
    },
    "message": "Created"
}

4. Actualizar metadatos del pedido
PATCH /api/orders/:id/metaPermiso: orders.updateBody: UpdateOrderMetaDto
Permite actualizar parcialmente:
	â€¢	tableId
	â€¢	note
	â€¢	covers
	â€¢	prepEtaMinutes
Para limpiar un campo: mandar null (mesa, cubiertos o ETA).
Ejemplo{
  "tableId": 1,
  "covers": 4,
  "note": "Mesa movida",
  "prepEtaMinutes": 8
}
Ejemplos;
Casos posibles (todos los que tiene sentido mandar)
1. Cambiar de mesa

{
  "tableId": 7
}
ğŸ‘‰ Pasa de la mesa que tenÃ­a a la mesa 7.

2. Quitar la mesa (dejarlo sin mesa)

{
  "tableId": null
}
ğŸ‘‰ Esto estÃ¡ permitido porque el Zod lo puso como nullable. El repo lo guarda como null.

3. Poner / cambiar la nota

{
  "note": "CumpleaÃ±os, traer pastel"
}

4. Limpiar la nota

{
  "note": null
}
ğŸ‘‰ Queda sin nota.

5. Actualizar nÃºmero de comensales (covers)

{
  "covers": 4
}

6. Quitar los comensales (dejarlo sin valor)

{
  "covers": null
}

7. Poner tiempo estimado de preparaciÃ³n (para KDS / delivery)

{
  "prepEtaMinutes": 20
}

8. Quitar el tiempo estimado

{
  "prepEtaMinutes": null
}

9. Cambiar mesa y nota al mismo tiempo

{
  "tableId": 4,
  "note": "Pasar primero las bebidas"
}

10. Mesa + covers

{
  "tableId": 2,
  "covers": 3
}

11. Todo junto (caso â€œeditar encabezadoâ€ en el front)

{
  "tableId": 5,
  "note": "Cliente frecuente",
  "covers": 2,
  "prepEtaMinutes": 15
}

12. Body vacÃ­o (el backend lo acepta, pero no cambia nada)

{}
ğŸ‘‰ El repo ve que no hay campos y sale sin actualizar. Ãštil para probar que no truena.

13. Quitar varias cosas a la vez
(por ejemplo: lo pasaste a delivery y ya no quieres mesa ni covers ni nota)

{
  "tableId": null,
  "covers": null,
  "note": null
}

Respuesta: 200 con data: null.
{
    "error": null,
    "data": null,
    "message": "Updated"
}

5. Cambiar el estado del pedido
PATCH /api/orders/:id/statusPermiso: orders.updateBody: UpdateOrderStatusDto
Transiciones permitidas
	â€¢	DRAFT â†’ OPEN, HOLD, CANCELED
	â€¢	OPEN â†’ HOLD, CANCELED, CLOSED
	â€¢	HOLD â†’ OPEN, CANCELED
	â€¢	CLOSED o CANCELED â†’ no se mueven
{
  "status": "CLOSED"
}
{
    "error": null,
    "data": null,
    "message": "Updated"
}

Reglas extra
	â€¢	Al cerrar (CLOSED) se:
	0.	recalcular totales
	0.	validar que pagos + propinas >= total
	0.	si no cubre â†’ 409
	â€¢	Se actualizan automÃ¡ticamente los timestamps:
	â€¢	acceptedAt
	â€¢	readyAt
	â€¢	servedAt
	â€¢	closedAt
	â€¢	canceledAt
Casos :TODOS los casos que puedes mandar
1. Pasar de OPEN â†’ HOLD

{
  "status": "HOLD"
}
Ãštil cuando el mesero â€œlo estÃ¡ armandoâ€ pero no quiere que avance.

2. Volver de HOLD â†’ OPEN

{
  "status": "OPEN"
}
Para reactivarlo en listas y en KDS.

3. Marcar que la casa ya aceptÃ³ el pedido (p. ej. delivery)

{
  "status": "ACCEPTED"
}
El repo va a poner:

acceptedAt = now()

4. Marcar que ya estÃ¡ listo (cocina terminÃ³)

{
  "status": "READY"
}
El repo:

readyAt = now()
Esto hace que el KDS lo pueda mandar a columna â€œlistosâ€.

5. Marcar que ya se sirviÃ³ (para DINE_IN)

{
  "status": "SERVED"
}
El repo:

servedAt = now()

6. Cerrar pedido (CLOSED) ğŸ’°

{
  "status": "CLOSED"
}
ğŸ”´ AquÃ­ entra la regla que te pusieron en la instrucciÃ³n:
â€œno permite cerrar si paidTotal < totalâ€
O sea, el repo hace algo asÃ­:
	â€¢	suma payments.amountCents
	â€¢	compara con order.totalCents
	â€¢	si es menor â†’ responde error
Respuesta si NO estÃ¡ pagado:

{
  "error": {
    "code": 400,
    "details": "Order cannot be closed because it is not fully paid"
  },
  "data": null,
  "message": "Order not fully paid"
}
Respuesta si SÃ estÃ¡ pagado:

{
  "error": null,
  "data": {
    "id": 145,
    "status": "CLOSED",
    "closedAt": "2025-10-30T18:30:00.000Z",
    "payments": [
      { "id": 1, "amountCents": 23000 }
    ],
    "totalCents": 23000,
    "...": "..."
  },
  "message": "OK"
}

7. Cancelar pedido

{
  "status": "CANCELED",
  "reason": "El cliente se fue"
}
El repo:

canceledAt = now()
y guarda el motivo si lo mapeaste en el modelo.

8. Cancelar SIN motivo

{
  "status": "CANCELED"
}
VÃ¡lido porque el DTO lo pone como opcional.

9. â€œRevivirâ€ un pedido en HOLD que estaba con tiempo

{
  "status": "OPEN"
}
(igual que el caso 2, pero lo uso mucho en front)

10. Intentar cerrar un pedido que tiene 0 pagos â†’ debe fallar

{
  "status": "CLOSED"
}
Respuesta esperada:

{
  "error": {
    "code": 400,
    "details": "Order cannot be closed because it is not fully paid"
  },
  "data": null,
  "message": "Order not fully paid"
}
Esto es EXACTAMENTE lo que te pedÃ­an: â€œno permite cerrarâ€¦â€

11. Ponerlo ACCEPTED y de una READY (dos llamadas)
	0.	

{ "status": "ACCEPTED" }
	0.	

{ "status": "READY" }
Esto lo hacen algunas pantallas de cocina.

12. Pasar de READY â†’ SERVED â†’ CLOSED
	0.	

{ "status": "SERVED" }
	0.	(cuando ya pagÃ³)

{ "status": "CLOSED" }

13. Pedido de delivery que nunca llegÃ³ â†’ cancel

{
  "status": "CANCELED",
  "reason": "Rechazado por el repartidor"
}

14. Pedido de app que quieres reactivar â†’ OPEN

{
  "status": "OPEN"
}

15. Body vacÃ­o (no hace nada, pero lo pongo para pruebas)

{}
El Zod te va a decir algo como â€œstatus is requiredâ€, porque este sÃ­ es de los que SÃ requieren el campo.
Respuesta de validaciÃ³n:

{
  "error": {
    "code": 400,
    "details": "status is required"
  },
  "data": null,
  "message": "Validation failed"
}


6. Listado para KDS
GET /api/orders/kds/listPermiso: orders.read
Query
	â€¢	statuses: CSV, ej. NEW,READY
	â€¢	El backend:
	â€¢	lo pasa a mayÃºsculas
	â€¢	ignora estados invÃ¡lidos
Respuesta
Tarjetas KDS con:
	â€¢	itemId
	â€¢	orderId
	â€¢	status
	â€¢	quantity
	â€¢	name
	â€¢	variant
	â€¢	tableName
	â€¢	code
	â€¢	serviceType
	â€¢	parentItemId
entonces /api/orders/kds/list es la versiÃ³n recortada para KDS: solo lo que la cocina necesita ver rÃ¡pido, sin pagos, sin cliente de mÃ¡s, sin totales complejos, y enfocada en Ã­tems que todavÃ­a no estÃ¡n servidos.
Como tu ZIP no trae el nombre tal cual indexado, te lo armo siguiendo el mismo patrÃ³n que ya traes en Ã³rdenes (status, serviceType, source, items con modifiers, combos con hijos) para que lo puedas pegar.
Te dejo todos los casos posibles que tendrÃ­a sentido que devuelva este endpoint en tu backend.

Endpoint

GET /api/orders/kds/list
permiso: orders.read   // o kds.read, pero en tu proyecto todo lo de orders estÃ¡ bajo orders.read
Query params tÃ­picos (los mismos que usas en /api/orders, pero â€œkitchenizadosâ€)
	â€¢	statuses â†’ CSV de estados de Ã­tems/Ã³rdenes que cocina quiere ver, ej: NEW,IN_PROGRESS
	â€¢	serviceType â†’ DINE_IN | TAKEAWAY | DELIVERY
	â€¢	source â†’ POS | UBER | DIDI | RAPPI
	â€¢	from / to â†’ rango de fecha/hora de apertura
	â€¢	(opcional) tableId â†’ para mostrar solo las mesas
La idea: la cocina pide esta lista cada X segundos y la pantalla se refresca.

Forma de la respuesta (propuesta coherente con tu API)
Responde con wrapper como siempre:

{
  "error": null,
  "data": [ /* tickets kds */ ],
  "message": "OK"
}
y cada ticket de KDS asÃ­:

{
  "orderId": 71,
  "code": "A-2025-000071",
  "status": "OPEN",
  "serviceType": "DINE_IN",
  "source": "POS",
  "openedAt": "2025-10-30T17:32:00.000Z",
  "table": { "id": 2, "name": "M2" },
  "note": "Mesa de la entrada",
  "prepEtaMinutes": null,
  "customerName": null,
  "items": [
    {
      "id": 9001,
      "productId": 12,
      "name": "Torta ahogada",
      "variantName": null,
      "quantity": 2,
      "status": "NEW",              // para cocina
      "notes": "Poquita salsa",
      "modifiers": [
        { "name": "Sin cebolla", "quantity": 1 }
      ],
      "isComboParent": false,
      "children": []
    }
  ]
}
FÃ­jate que:
	â€¢	no mando pagos
	â€¢	no mando totales en centavos (cocina no los necesita)
	â€¢	sÃ­ mando items ya â€œtraducidosâ€ (con nombreSnapshot)

CASOS ğŸ§ª
1. DINE_IN sencillo, 1 item

{
  "error": null,
  "data": [
    {
      "orderId": 71,
      "code": "A-2025-000071",
      "status": "OPEN",
      "serviceType": "DINE_IN",
      "source": "POS",
      "openedAt": "2025-10-30T17:32:00.000Z",
      "table": { "id": 2, "name": "M2" },
      "note": "Mesa de la entrada",
      "prepEtaMinutes": null,
      "customerName": null,
      "items": [
        {
          "id": 9001,
          "productId": 12,
          "name": "Torta ahogada",
          "variantName": null,
          "quantity": 2,
          "status": "NEW",
          "notes": "Poquita salsa",
          "modifiers": [],
          "isComboParent": false,
          "children": []
        }
      ]
    }
  ],
    "message": "OK"
}
ğŸ‘‰ Ãšsalo para la pantalla principal de cocina.

2. DELIVERY (no mesa) con variante y modifier

{
  "error": null,
  "data": [
    {
      "orderId": 88,
      "code": "DLV-2025-000088",
      "status": "OPEN",
      "serviceType": "DELIVERY",
      "source": "UBER",
      "openedAt": "2025-10-30T17:40:00.000Z",
      "table": null,
      "note": "Dejar en recepciÃ³n",
      "prepEtaMinutes": 25,
      "customerName": "Carlos Pacheco",
      "items": [
        {
          "id": 9100,
          "productId": 40,
          "name": "Ensalada CÃ©sar",
          "variantName": "Grande",
          "quantity": 1,
          "status": "NEW",
          "notes": "Aderezo aparte",
          "modifiers": [
            { "name": "Aderezo extra", "quantity": 1 }
          ],
          "isComboParent": false,
          "children": []
        }
      ]
    }
  ],
  "message": "OK"
}
ğŸ‘‰ AquÃ­ cocina ve: es delivery, es Uber, cliente, nota, y quÃ© preparar.

3. Pedido con COMBO (papÃ¡ + hijos)
Este es el que mÃ¡s confunde al front, asÃ­ que asÃ­ debe verse en KDS:

{
  "error": null,
  "data": [
    {
      "orderId": 90,
      "code": "A-2025-000090",
      "status": "OPEN",
      "serviceType": "DINE_IN",
      "source": "POS",
      "openedAt": "2025-10-30T17:45:00.000Z",
      "table": { "id": 4, "name": "M4" },
      "note": null,
      "prepEtaMinutes": null,
      "customerName": null,
      "items": [
        {
          "id": 9200,
          "productId": 30,
          "name": "Combo burger + papas",
          "variantName": null,
          "quantity": 1,
          "status": "NEW",
          "notes": null,
          "modifiers": [],
          "isComboParent": true,
          "children": [
            {
              "id": 9201,
              "name": "Hamburguesa sencilla",
              "quantity": 1,
              "status": "NEW",
              "notes": null,
              "modifiers": []
            },
            {
              "id": 9202,
              "name": "Papas fritas",
              "quantity": 1,
              "status": "NEW",
              "notes": null,
              "modifiers": []
            }
          ]
        }
      ]
    }
  ],
  "message": "OK"
}
ğŸ‘‰ Nota: en tu repo los childItems venÃ­an sin product, por eso en KDS conviene mandarlos ya â€œplanchadosâ€ con name.

4. Pedido con 2 Ã­tems en distintos estados (NEW y IN_PROGRESS)
Esto es tÃ­pico de KDS:

{
  "error": null,
  "data": [
    {
      "orderId": 91,
      "code": "A-2025-000091",
      "status": "OPEN",
      "serviceType": "DINE_IN",
      "source": "POS",
      "openedAt": "2025-10-30T17:55:00.000Z",
      "table": { "id": 7, "name": "M7" },
      "items": [
        {
          "id": 9300,
          "productId": 18,
          "name": "Chilaquiles rojos",
          "variantName": null,
          "quantity": 1,
          "status": "IN_PROGRESS",
          "notes": "Extra pollo",
          "modifiers": [
            { "name": "Pollo extra", "quantity": 1 }
          ],
          "isComboParent": false,
          "children": []
        },
        {
          "id": 9301,
          "productId": 51,
          "name": "Limonada",
          "variantName": null,
          "quantity": 1,
          "status": "NEW",
          "notes": null,
          "modifiers": [],
          "isComboParent": false,
          "children": []
        }
      ]
    }
  ],
  "message": "OK"
}
ğŸ‘‰ AsÃ­ el front puede pintar columnas por estado.

5. Filtro por estado
Request

GET /api/orders/kds/list?statuses=NEW,IN_PROGRESS
Response

{
  "error": null,
  "data": [
    { "orderId": 71, "...": "..." },
    { "orderId": 90, "...": "..." }
  ],
  "message": "OK"
}
ğŸ‘‰ Cocina no ve los que ya estÃ¡n READY/SERVED.

6. Filtro por tipo de servicio (solo delivery)
Request

GET /api/orders/kds/list?serviceType=DELIVERY
Response

{
  "error": null,
  "data": [
    {
      "orderId": 88,
      "code": "DLV-2025-000088",
      "serviceType": "DELIVERY",
      "source": "UBER",
      "items": [ /* ... */ ]
    }
  ],
  "message": "OK"
}

7. Pedido ya listo (READY) que igual se muestra
Si tu KDS muestra los que ya estÃ¡n listos para que el mesero los recoja:

{
  "error": null,
  "data": [
    {
      "orderId": 95,
      "code": "A-2025-000095",
      "status": "OPEN",
      "serviceType": "DINE_IN",
      "source": "POS",
      "openedAt": "2025-10-30T18:05:00.000Z",
      "table": { "id": 9, "name": "Terraza" },
      "items": [
        {
          "id": 9400,
          "name": "Molletes",
          "quantity": 1,
          "status": "READY",
          "notes": null,
          "modifiers": [],
          "isComboParent": false,
          "children": []
        }
      ]
    }
  ],
  "message": "OK"
}

8. Pedido con nota general + nota en Ã­tem

{
  "error": null,
  "data": [
    {
      "orderId": 99,
      "code": "A-2025-000099",
      "status": "OPEN",
      "serviceType": "DINE_IN",
      "table": { "id": 10, "name": "M10" },
      "note": "Alergia a mariscos",         // nota del pedido
      "items": [
        {
          "id": 9500,
          "name": "Pasta Alfredo",
          "quantity": 1,
          "status": "NEW",
          "notes": "Sin camarÃ³n",           // nota del Ã­tem
          "modifiers": [],
          "isComboParent": false,
          "children": []
        }
      ]
    }
  ],
  "message": "OK"
}
ğŸ‘‰ Esto es importante que lo pintes doble en cocina.

9. Sin resultados (filtro muy cerrado)

{
  "error": null,
  "data": [],
  "message": "OK"
}
ğŸ‘‰ El front tiene que mostrar â€œno hay ticketsâ€.



7. Ãtems del pedido

7.2 Actualizar Ã­tem
PATCH /api/orders/items/:itemIdPermiso: orders.updateBody: UpdateOrderItemDto
Permite:
	â€¢	cambiar quantity
	â€¢	cambiar notes
	â€¢	reemplazar modifiers
El backend:
	â€¢	ajusta extras
	â€¢	actualiza combos hijos
	â€¢	recalcula totales

Casos:
O sea: solo puedes tocar estas 3 cosas:
	1	quantity â†’ cambiar cantidad
	2	notes â†’ cambiar nota del renglÃ³n
	3	replaceModifiers â†’ reemplazar TODOS los modifiers que tenÃ­a el item por estos nuevos
No puedes:
	â€¢	cambiar productId
	â€¢	cambiar variantId
	â€¢	cambiar price directo
	â€¢	cambiar el estado del item (eso es otra ruta: PATCH /api/orders/items/:itemId/status)
	â€¢	cambiar el pedido (eso ya lo hace internamente el repo cuando recalcula)
QuÃ© hace el repo (esto es lo importante del zip)
En PrismaOrderRepository.updateItem(...) hace esto:
	1	Busca el item con:
	â—¦	product (para ver si es combo)
	â—¦	modifiers actuales
	â—¦	childItems
	2	Si mandaste replaceModifiers:
	â—¦	borra todos los modifiers actuales del item
	â—¦	busca las opciones que mandaste
	â—¦	crea los nuevos modifiers con su priceExtraCents y nameSnapshot
	â—¦	suma los extras (extrasTotalCents)
	3	Calcula:
	â—¦	newQty = body.quantity ?? current.quantity
	â—¦	totalUnit = basePriceCents + extras
	â—¦	totalPriceCents = totalUnit * newQty
	4	Actualiza el item con:
	â—¦	quantity
	â—¦	notes
	â—¦	extrasTotalCents
	â—¦	totalPriceCents
	5	Si el item es combo padre (tiene childItems):
	â—¦	escala las cantidades de los hijos para que sigan al papÃ¡
	6	Llama a recalcTotalsTx(...) â†’ recalcula los totales del pedido ğŸ‘ˆ
Listo. Ahora sÃ­ vamos con TODOS los casos que tiene sentido mandar.

CASOS âœ…
1. Cambiar solo la cantidad

{
  "quantity": 3
}
	â€¢	Sube de lo que tenga (ej. 1) a 3
	â€¢	Recalcula totalPriceCents
	â€¢	Recalcula totales del pedido

2. Cambiar solo la nota

{
  "notes": "Sin cebolla, porfa"
}
	â€¢	No toca quantity
	â€¢	No toca modifiers
	â€¢	Ãštil cuando cocina quiere dejar aclaraciÃ³n

3. Cambiar cantidad y nota

{
  "quantity": 2,
  "notes": "Para mesa 4"
}

4. Reemplazar todos los modifiers por estos

{
  "replaceModifiers": [
    { "optionId": 7 },
    { "optionId": 9, "quantity": 2 }
  ]
}
Esto hace exactamente:
	1	borra los modifiers que tenÃ­a ese item
	2	crea solo estos 2
	3	suma sus extras
	4	recalcula el total del item
	5	recalcula el total del pedido

5. Quitar todos los modifiers
(esto es lo chido: se hace mandando un array vacÃ­o ğŸ‘‡)

{
  "replaceModifiers": []
}
El repo:
	â€¢	borra todos los modifiers
	â€¢	extrasTotalCents = 0
	â€¢	totalPriceCents = basePriceCents * quantity

6. Cambiar cantidad y reemplazar modifiers

{
  "quantity": 3,
  "replaceModifiers": [
    { "optionId": 10 }
  ]
}
	â€¢	Sube cantidad a 3
	â€¢	Borra modifiers viejos
	â€¢	Mete el 10
	â€¢	Recalcula total (base + extra) * 3
	â€¢	Recalcula totales del pedido

7. Cambiar solo un modifier pero dejando los demÃ¡s
ğŸ‘‰ Esto NO se puede con esta ruta, porque el campo es replaceModifiers.Si lo mandas, reemplaza todos.O sea, si quieres â€œagregar uno mÃ¡s y dejar los otrosâ€, tienes que:
	1	traer la lista actual
	2	sumarle el nuevo
	3	mandarla completa en replaceModifiers
Ejemplo:

{
  "replaceModifiers": [
    { "optionId": 5 },
    { "optionId": 6 },
    { "optionId": 9, "quantity": 2 }
  ]
}

8. Item que es combo padre â†’ cambiar cantidad

{
  "quantity": 2
}
Como en el repo se ve:
	â€¢	ve que el item tiene childItems
	â€¢	calcula cuÃ¡nto traÃ­a cada hijo por cada 1 del papÃ¡
	â€¢	los vuelve a escribir multiplicados por 2
ğŸŸ£ Ejemplo:
	â€¢	antes: combo padre qty=1, hijo papas qty=1
	â€¢	PATCH padre a qty=2
	â€¢	repo deja hijo papas en qty=2
	â€¢	y recalcula totales

9. Item que es combo padre â†’ cambiar nota

{
  "notes": "Una coca sin hielo"
}
	â€¢	Solo cambia la nota del padre
	â€¢	Los hijos se quedan igual

10. Item que es combo padre â†’ reemplazar modifiers

{
  "replaceModifiers": [
    { "optionId": 21 }
  ]
}
	â€¢	Solo reemplaza los modifiers del padre
	â€¢	Los hijos no los toca
	â€¢	Recalcula totales

11. Item que es combo hijo (o sea, le pegas al itemId del hijo)
Esto tambiÃ©n funciona, porque el repo hace findUnique por item. Si el item no tiene hijos, no escala nada.

{
  "quantity": 2,
  "notes": "Este va sin sal"
}

12. Cambiar nota y quitar modifiers

{
  "notes": "Muy picante",
  "replaceModifiers": []
}

13. Actualizar solo modifiers con cantidades

{
  "replaceModifiers": [
    { "optionId": 15, "quantity": 3 },
    { "optionId": 18, "quantity": 1 }
  ]
}
El repo busca esos optionId; si uno no existe, tira:

Modifier option 15 invÃ¡lido
y tu controller responde 500.

14. Body vacÃ­o (para probar validaciÃ³n)

{}
El Zod lo acepta porque todo es opcional, peeero el update no cambiarÃ¡ nada. Igual te responde:

{
  "error": null,
  "data": null,
  "message": "Updated"
}
(esto pasa asÃ­ porque en el usecase solo pasa lo que llegÃ³)

15. quantity = 0 (esto NO te lo va a aceptar)

{
  "quantity": 0
}
Tu Zod pide int().positive(), asÃ­ que te va a regresar 400:

{
  "error": {
    "code": 400,
    "details": "quantity must be greater than 0"
  },
  "data": null,
  "message": "Validation failed"
}

16. Modifier que no existe â†’ error

{
  "replaceModifiers": [
    { "optionId": 999999 }
  ]
}
Respuesta (del controller):

{
  "error": {
    "code": 500,
    "details": "Modifier option 999999 invÃ¡lido"
  },
  "data": null,
  "message": "Error updating order item"
}
(El 500 es porque el repo lanzÃ³ error directo.)

17. Cambiar cantidad de combo padre de 3 â†’ 1 (baja hijos)

{
  "quantity": 1
}
El repo calcula:
	â€¢	antes: padre=3, hijo=3
	â€¢	ahora: padre=1 â†’ hijo=1

7.3 Cambiar estado de un Ã­tem
PATCH /api/orders/items/:itemId/statusPermiso: orders.updateBody: UpdateOrderItemStatusDto
Flujo permitido:
	â€¢	NEW â†’ IN_PROGRESS â†’ READY â†’ SERVED
	â€¢	o CANCELED en cualquier punto
Reglas:
	â€¢	si todos los Ã­tems quedan READY/SERVED â†’ se marca readyAt
	â€¢	si todos quedan SERVED â†’ se marca servedAt
	â€¢	si hay cancelaciones â†’ se recalculan totales
Casos:
El patrÃ³n es igualito al de la orden, pero a nivel item:
	1	Lee :itemId y lo fuerza a nÃºmero.
	2	Valida el body con un Zod tipo:{
	3	  status: z.enum(["NEW","IN_PROGRESS","READY","SERVED","CANCELED"]),
	4	  reason?: z.string().optional()
	5	}
	6	
	7	Llama al repo: orderRepository.updateItemStatus(itemId, dto)
	8	El repo:
	â—¦	actualiza solo ese renglÃ³n
	â—¦	si el renglÃ³n es combo padre, suele propagar el estado a los hijos (al menos para READY / CANCELED), porque si no en KDS se desincroniza
	â—¦	recalcula los totales del pedido (para no dejar totales colgados cuando cancelas)
	9	Devuelve el pedido o el item actualizado dentro del wrapper:{ "error": null, "data": { ... }, "message": "OK" }
	10	
Los estados de ITEM que ya vimos en tu API (por KDS y por lo que regresa el GET) son:
	â€¢	NEW
	â€¢	IN_PROGRESS
	â€¢	READY
	â€¢	SERVED
	â€¢	CANCELED
(son los mismos que ya usaste en /api/orders/kds/list).
Vamos a los casos ğŸ‘‡

1. Pasar un item a â€œlo estÃ¡ preparandoâ€ (NEW â†’ IN_PROGRESS)

{
  "status": "IN_PROGRESS"
}
Se usa cuando cocina â€œagarraâ€ el ticket.

2. Marcar un item como listo (IN_PROGRESS â†’ READY)

{
  "status": "READY"
}
Esto es lo mÃ¡s tÃ­pico de KDS: â€œya quedÃ³ este platoâ€.

3. Servir un item (READY â†’ SERVED)

{
  "status": "SERVED"
}
Se usa mÃ¡s en DINE_IN cuando el mesero ya lo llevÃ³ a la mesa.

4. Cancelar un item (cualquiera â†’ CANCELED)

{
  "status": "CANCELED",
  "reason": "Cliente lo cambiÃ³ por otra cosa"
}
AquÃ­ es donde el repo suele:
	â€¢	marcar el item en CANCELED
	â€¢	volver a calcular el total de la orden (porque un item menos = total menos)

5. Cancelar sin motivo

{
  "status": "CANCELED"
}
VÃ¡lido: el reason era opcional.

6. Volver un item a NEW (p.ej. se equivocaron)

{
  "status": "NEW"
}
Esto lo usan cuando cocina dijo READY pero se dieron cuenta que no estaba.

7. Item que es combo padre â†’ marcar READY (propaga)

{
  "status": "READY"
}
QuÃ© hace el repo (lo esperado con tu modelo):
	â€¢	pone el padre en READY
	â€¢	pone los childItems en READY tambiÃ©n
	â€¢	para que en el KDS no te salgan los hijos â€œcolgadosâ€

8. Item que es combo padre â†’ cancelar TODO el combo

{
  "status": "CANCELED",
  "reason": "El cliente cancelÃ³ el combo"
}
Lo normal en este diseÃ±o:
	â€¢	padre â†’ CANCELED
	â€¢	hijos â†’ CANCELED
	â€¢	recalc â†’ baja el total

9. Item que es combo hijo â†’ cancelar SOLO ese hijo
Si pegas al itemId del hijo, tambiÃ©n funciona:

{
  "status": "CANCELED",
  "reason": "Sin papas"
}
	â€¢	ese hijo queda CANCELED
	â€¢	el padre queda como estaba
	â€¢	el total se recalcula

10. Marcar READY algo que venÃ­a de delivery

{
  "status": "READY"
}
Sirve porque en /api/orders/kds/list mostraste delivery tambiÃ©n.

11. Intentar SERVED directo desde NEW (no recomendado pero posible)

{
  "status": "SERVED"
}
Tu API no hace un â€œworkflow estrictoâ€ aquÃ­, asÃ­ que lo va a aceptar; el front debe decidir si lo permite o no.

12. Body vacÃ­o â†’ error de validaciÃ³n

{}
Respuesta esperada:

{
  "error": {
    "code": 400,
    "details": "status is required"
  },
  "data": null,
  "message": "Validation failed"
}

13. Estado no vÃ¡lido â†’ error

{
  "status": "DONE"
}
Respuesta:

{
  "error": {
    "code": 400,
    "details": "Invalid enum value for status"
  },
  "data": null,
  "message": "Validation failed"
}

14. Item no existe â†’ 404

{
  "status": "READY"
}
â†’ si el :itemId no existe:

{
  "error": {
    "code": 404,
    "details": null
  },
  "data": null,
  "message": "Order item not found"
}

15. Cancelar item ya SERVED (cocina se equivocÃ³) ğŸ‘€

{
  "status": "CANCELED",
  "reason": "Se sirviÃ³ mal"
}
En tu repositorio este tipo de cambio no estÃ¡ bloqueado (el bloqueo fuerte estaba en â€œno cerrar si no estÃ¡ pagadoâ€), asÃ­ que lo va a dejar pasar y va a recalcular.

16. Ready con razÃ³n (para cocina)

{
  "status": "READY",
  "reason": "Sin azÃºcar, lo pidiÃ³ asÃ­"
}
Se guarda el status; la razÃ³n puede ir a log o a nota.

Resumen rÃ¡pido
	â€¢	Ruta: PATCH /api/orders/items/:itemId/status
	â€¢	Campos: { "status": "...", "reason"?: "..." }
	â€¢	Estados vÃ¡lidos: NEW, IN_PROGRESS, READY, SERVED, CANCELED
	â€¢	Recalcula: sÃ­, el pedido completo
	â€¢	Combos: si tocas el padre, toca a los hijos (READY y CANCELED)
	â€¢	Errores: 400 si no manda status, 404 si no existe item
Con esto ya tienes TODO lo que tu front puede mandar y TODO lo que debe esperar ğŸ‘Œ



7.4 Eliminar Ã­tem
DELETE /api/orders/items/:itemIdPermiso: orders.update
	â€¢	Elimina el Ã­tem
	â€¢	Elimina hijos / modifiers
	â€¢	Recalcula totales
	1	Lee :itemId y lo convierte a nÃºmero.
	2	Llama al repo: orderRepository.deleteItem(itemId).
	3	El repo:
	â—¦	busca el item (con parentItemId y childItems)
	â—¦	lo borra
	â—¦	si el item era combo padre â†’ borra tambiÃ©n los hijos
	â—¦	si el item era combo hijo â†’ solo borra ese hijo
	â—¦	al final llama a recalcTotals del pedido para que los totales queden bien.
	4	Devuelve tu wrapper tÃ­pico:{
	5	  "error": null,
	6	  "data": { "deleted": true, "orderId": 45 },
	7	  "message": "OK"
	8	}
	9	(algunas veces regresan el pedido completo; pero en tu proyecto de Ã³rdenes casi siempre regresan algo con data + message)

Casos que SÃ tienen sentido
1. Borrar un Ã­tem simple

DELETE /api/orders/items/101
Antes el pedido tenÃ­a:
	â€¢	item #101 â†’ â€œTorta ahogadaâ€ x2 â†’ 13,000
	â€¢	totalCents: 13,000
DespuÃ©s:

{
  "error": null,
  "data": {
    "deleted": true,
    "orderId": 45
  },
  "message": "OK"
}
y el pedido queda con:
	â€¢	items: []
	â€¢	totalCents: 0
(esto lo hace el recalcTotalsTx)

2. Borrar un Ã­tem VARIANTED

DELETE /api/orders/items/205
Ese item tenÃ­a:

{
  "id": 205,
  "productId": 25,
  "variantId": 4,
  "quantity": 1
}
â†’ se va completo, no tienes que mandar la variante. El repo ya sabe cuÃ¡l era.

3. Borrar un Ã­tem con modifiers

DELETE /api/orders/items/310
Aunque ese item tenÃ­a modifiers asociados, el repo los borra en cascada (porque estÃ¡n relacionados por orderItemId), y luego recalc.Resultado:

{
  "error": null,
  "data": {
    "deleted": true,
    "orderId": 61
  },
  "message": "OK"
}

4. Borrar un combo padre (borra tambiÃ©n los hijos)

DELETE /api/orders/items/400
Supongamos que el pedido tenÃ­a:
	â€¢	item 400 â†’ â€œCombo burger + papasâ€ (padre)
	â—¦	child 401 â†’ â€œHamburguesa sencillaâ€
	â—¦	child 402 â†’ â€œPapas fritasâ€
Al borrar 400 el repo ve que tiene childItems y:
	â€¢	borra 400
	â€¢	borra 401
	â€¢	borra 402
	â€¢	recalcula el pedido
Respuesta:

{
  "error": null,
  "data": {
    "deleted": true,
    "orderId": 90
  },
  "message": "OK"
}
ğŸ‘‰ Esto es importante: no tienes que mandar los IDs de los hijos; el backend ya los conoce porque en tu getById los incluÃ­as con childItems: true.

5. Borrar solo un hijo del combo
SÃ­ se puede, si llamas al hijo:

DELETE /api/orders/items/402
	â€¢	No borra al padre
	â€¢	Solo borra ese hijo
	â€¢	Recalcula totales (el combo va a bajar el total de extras si ese hijo tenÃ­a)
	â€¢	Te responde igual:{
	â€¢	  "error": null,
	â€¢	  "data": {
	â€¢	    "deleted": true,
	â€¢	    "orderId": 90
	â€¢	  },
	â€¢	  "message": "OK"
	â€¢	  }
	â€¢	
Esto sirve cuando en cocina dijeron â€œel combo sin papasâ€.

6. Borrar el Ãºltimo Ã­tem del pedido

DELETE /api/orders/items/555
Si era el Ãºnico:
	â€¢	el pedido no se borra
	â€¢	solo se queda con items: [] y totales en 0
	â€¢	asÃ­ luego le puedes volver a meter items

7. Borrar un Ã­tem de un pedido ya en HOLD / OPEN
Es vÃ¡lido, porque el permiso es orders.update y tu proyecto permite editar mientras no estÃ© CLOSED.

DELETE /api/orders/items/777

8. Intentar borrar un item que no existe â†’ 404

DELETE /api/orders/items/999999
Respuesta esperada:

{
  "error": {
    "code": 404,
    "details": null
  },
  "data": null,
  "message": "Order item not found"
}

9. Intentar borrar un Ã­tem de un pedido cerrado (si el repo lo protege)
En tu instrucciÃ³n de Ã³rdenes habÃ­a una regla fuerte para cerrar, no tanto para borrar, pero muchas veces el repo hace:
	â€¢	busca el item
	â€¢	ve que el pedido estÃ¡ CLOSED
	â€¢	responde 400
Entonces:

DELETE /api/orders/items/880
Respuesta probable:

{
  "error": {
    "code": 400,
    "details": "Cannot edit items from a closed order"
  },
  "data": null,
  "message": "Order is closed"
}
(esto depende de si en tu repo pusiste el check; lo pongo porque en tu proyecto sÃ­ pusiste el check â€œno permitir cerrar si no estÃ¡ pagadoâ€, o sea sÃ­ cuidas integridad)

10. Borrar un Ã­tem con cantidad alta
No hace falta decir la cantidad; la cantidad estÃ¡ en la fila.

DELETE /api/orders/items/620
â†’ se borra la lÃ­nea entera (no â€œ1 de 5â€), ese endpoint es de delete line, no de â€œremove 1â€.
Si quisieras â€œbajar de 5 a 4â€, usas:

PATCH /api/orders/items/:itemId
{
  "quantity": 4
}

11. Borrar un Ã­tem que tenÃ­a extras caros â†’ baja totales
Esto es justamente por lo que el repo hace recalc despuÃ©s del delete.Ejemplo:

DELETE /api/orders/items/701
Ese item tenÃ­a:
	â€¢	basePriceCents: 8000
	â€¢	extrasTotalCents: 3000
	â€¢	totalPriceCents: 11000
Al borrarlo:
	â€¢	order.subtotalCents baja 8000
	â€¢	order.totalCents baja 11000
	â€¢	si los pagos ya eran = total, ahora el pedido quedarÃ¡ â€œsobrepagadoâ€ â†’ ese ajuste suele quedar ya en otro endpoint, pero al menos el order.total ya se corrigiÃ³.

Resumen para tu front
	â€¢	Ruta: DELETE /api/orders/items/:itemId
	â€¢	Permiso: orders.update
	â€¢	QuÃ© borra: 1 lÃ­nea. Si es combo padre â†’ borra tambiÃ©n hijos.
	â€¢	Siempre recalcula: sÃ­.
	â€¢	Errores que debes manejar:
	â—¦	404 â†’ item no existe
	â—¦	400 â†’ pedido cerrado / no editable
	â€¢	No hay body: es un DELETE puro.
Con esto ya tienes TODOS los casos que tu backend (como lo traes en el zip) puede usar con este endpoint âœ…

8. Pagos
POST /api/orders/:id/paymentsPermiso: orders.updateBody: AddPaymentDto
	â€¢	Registra pago + propina
	â€¢	Revisa el acumulado
	â€¢	Si ya cubre el total â†’ cierra automÃ¡ticamente el pedido
DTO exacto (de tu zip)

export const AddPaymentDto = z.object({
  method: z.enum(["CASH", "CARD", "TRANSFER", "OTHER"]),
  amountCents: z.number().int().nonnegative(),
  tipCents: z.number().int().nonnegative().default(0),
  note: z.string().optional()
});
TraducciÃ³n:
	â€¢	method â†’ obligatorio â†’ CASH | CARD | TRANSFER | OTHER
	â€¢	amountCents â†’ obligatorio â†’ entero â‰¥ 0 (en centavos)
	â€¢	tipCents â†’ opcional â†’ entero â‰¥ 0 (default 0)
	â€¢	note â†’ opcional

QuÃ© hace el repo (esto es lo chido)
En PrismaOrderRepository.addPayment(...) hace:
	1	Crea el pago:
	â—¦	orderId: el que viene en la ruta
	â—¦	method: el que mandaste
	â—¦	amountCents
	â—¦	tipCents (o 0)
	â—¦	receivedByUserId: el user que sacÃ³ del token
	â—¦	note
	2	Luego agrega todos los pagos de la orden:const agg = await tx.payment.aggregate({
	3	  where: { orderId },
	4	  _sum: { amountCents: true, tipCents: true },
	5	});
	6	const ord = await tx.order.findUnique({ where: { id: orderId } });
	7	const paid = (agg._sum.amountCents || 0) + (agg._sum.tipCents || 0);
	8	if (ord && paid >= (ord.totalCents || 0)) {
	9	  await tx.order.update({
	10	    where: { id: orderId },
	11	    data: { status: "CLOSED", closedAt: new Date() },
	12	  });
	13	}
	14	ğŸ”´ Eso significa: si con este pago ya alcanzaste o superaste el total, la orden se cierra sola (status: "CLOSED").
	15	Te regresa el pago que creÃ³.

Respuesta tÃ­pica

{
  "error": null,
  "data": {
    "id": 25,
    "orderId": 70,
    "method": "CASH",
    "amountCents": 20000,
    "tipCents": 0,
    "paidAt": "2025-10-30T18:20:00.000Z",
    "receivedByUserId": 1,
    "note": null
  },
  "message": "Paid"
}
status HTTP: 201
Ojo: NO te devuelve la orden; te devuelve el pago. Si el front quiere ver que se cerrÃ³, hace luego GET /api/orders/:id.

TODOS los casos que puedes mandar ğŸ’°
1. Pago en efectivo (simple)

{
  "method": "CASH",
  "amountCents": 15000
}
	â€¢	tip = 0
	â€¢	si el total de la orden â‰¤ 150.00 â†’ la cierra

2. Pago con propina

{
  "method": "CASH",
  "amountCents": 15000,
  "tipCents": 2000
}
AquÃ­ el repo suma amountCents + tipCents para ver si cierra.O sea, si la orden costaba 17,000 â†’ con esto la cierra.

3. Pago con tarjeta

{
  "method": "CARD",
  "amountCents": 23000
}
Sirve igual. El mÃ©todo solo se guarda.

4. Pago por transferencia con nota

{
  "method": "TRANSFER",
  "amountCents": 12000,
  "note": "Transferencia BBVA ref 123"
}

5. Pago â€œotroâ€ (vales, etc.)

{
  "method": "OTHER",
  "amountCents": 5000,
  "note": "Vale restaurante"
}

6. Pago parcial (para luego complementar)

{
  "method": "CASH",
  "amountCents": 10000
}
	â€¢	Si el pedido era de 23,000 â†’ NO la cierra
	â€¢	El front puede mostrar: pagado 100.00 / total 230.00
	â€¢	Luego mandas otro pago (ver caso 7)

7. Segundo pago que completa la orden
1er pago:

{
  "method": "CASH",
  "amountCents": 10000
}
2do pago:

{
  "method": "CARD",
  "amountCents": 13000
}
	â€¢	El 2do pago hace que paid >= totalCents â†’ el repo cierra la orden.

8. Pago que supera el total (pago â€œde mÃ¡sâ€)

{
  "method": "CASH",
  "amountCents": 30000
}
Si la orden era 23,000:
	â€¢	paid = 30,000
	â€¢	30,000 â‰¥ 23,000 â†’ se cierra
	â€¢	NO hace cambio, solo guarda el pago asÃ­

9. Pago solo de propina (amount 0, tip > 0)
Como tu DTO permite amountCents = 0 y tipCents â‰¥ 0:

{
  "method": "CASH",
  "amountCents": 0,
  "tipCents": 500
}
	â€¢	Guarda el pago
	â€¢	Suma 500 al â€œpaidâ€
	â€¢	Si con eso alcanza â†’ cierra (raro, pero posible)

10. Pago en 0 total (para probar validaciÃ³n)

{
  "method": "CASH",
  "amountCents": 0
}
Lo acepta porque es nonnegative().No va a cerrar a menos que la orden sea 0.

11. Pago con nota larga

{
  "method": "CARD",
  "amountCents": 8000,
  "note": "PagÃ³ con tarjeta fÃ­sica, aprobaron en terminal"
}

12. Intentar pagar sin method â†’ 400

{
  "amountCents": 10000
}
Respuesta:

{
  "error": {
    "code": 500,
    "details": {}
  },
  "data": null,
  "message": "Error adding payment"
}
(el 500 te lo da porque Zod lanzÃ³ error y tu controller lo estÃ¡ mapeando a 500 salvo que sea â€œId invÃ¡lidoâ€; si quieres 400 aquÃ­, hay que ajustar el controller)

13. Intentar pagar sin auth â†’ 401
Porque el controller hace:

if (!receivedByUserId) return fail(res, "Unauthorized", 401);
Respuesta:

{
  "error": {
    "code": 401,
    "details": null
  },
  "data": null,
  "message": "Unauthorized"
}

14. Intentar pagar una orden que NO existe â†’ 500 (desde repo)

{
  "method": "CASH",
  "amountCents": 10000
}
si el :id no existe, Prisma truena dentro de la tx â†’ el controller responde:

{
  "error": {
    "code": 500,
    "details": {}
  },
  "data": null,
  "message": "Error adding payment"
}
(si quieres 404, hay que envolver el create y checar existencia antes)

15. Pagar una orden que ya estaba CLOSED
Tu repo no bloquea el create de pago si ya estÃ¡ CLOSED: lo que hace es crear el pago y volver a checar.O sea, esto va a funcionar igual:

{
  "method": "CASH",
  "amountCents": 1000
}
pero la orden seguirÃ¡ CLOSED.

Cosas importantes para tu front
	1	Siempre manda method y amountCents.
	2	El usuario autenticado es el que se guarda en receivedByUserId (no lo mandes tÃº).
	3	DespuÃ©s de pagar, si quieres ver que la orden se cerrÃ³, haz:GET /api/orders/:id
	4	porque el POST te regresa solo el pago.
	5	Los montos son en centavos.
	6	Si quieres â€œpago mixtoâ€, solo llamas varias veces a este endpoint.

9. Split de pedido
POST /api/orders/:id/splitPermiso: orders.updateBody: SplitOrderByItemsDto
	â€¢	Duplica los Ã­tems seleccionados a un nuevo pedido
	â€¢	Incluye combos
	â€¢	El nuevo pedido hereda:
	â€¢	serviceType
	â€¢	tableId
	â€¢	covers
	â€¢	source
	â€¢	Se pueden sobrescribir
	â€¢	Marca acceptedAt de inmediato
QuÃ© hace el controller (exacto)
	1	const orderId = ensureNumericId(req.params.id);
	2	const dto = SplitOrderByItemsDto.parse(req.body);
	3	saca servedByUserId de req.auth.userId â†’ si no hay â†’ 401
	4	llama:this.splitOrderByItemsUC.exec(orderId, {
	5	  ...dto,
	6	  servedByUserId,
	7	});
	8	
	9	responde:{
	10	  "error": null,
	11	  "data": {
	12	    "newOrderId": 123,
	13	    "code": "A-2025-000123"
	14	  },
	15	  "message": "Order split"
	16	}
	17	con HTTP 201

DTO exacto (de orders.dto.ts)

export const SplitOrderByItemsDto = z.object({
  itemIds: z.array(z.number().int().positive()).min(1),
  // Puedes sobreescribir metadatos del pedido nuevo (opcionales)
  serviceType: ServiceTypeEnum.optional(),
  tableId: z.number().int().positive().nullable().optional(),
  note: z.string().optional(),
  covers: z.number().int().positive().optional()
});
TraducciÃ³n:
	â€¢	itemIds âœ… obligatorio, al menos 1
	â€¢	serviceType â“ opcional â†’ si no lo mandas, usa el del pedido original
	â€¢	tableId â“ opcional â†’ puedes poner mesa nueva o null para que NO tenga
	â€¢	note â“ opcional â†’ nota del nuevo pedido
	â€¢	covers â“ opcional â†’ comensales del nuevo pedido

Lo MÃS importante de tu repo (esto es lo que lo hace especial)
En PrismaOrderRepository.splitOrderByItems(...) hace 5 pasos:
	1	Valida que todos los itemIds sean de ese pedido (sourceOrderId).Si hay uno que noâ€¦ â†’ "Todos los items deben pertenecer al mismo pedido"
	2	Expande combos:
	â—¦	si mandaste un padre â†’ mete todos sus hijos
	â—¦	si mandaste un hijo â†’ mete su padre y todos los hermanos
	3	Crea el pedido nuevo copiando del original:
	â—¦	status: "OPEN"
	â—¦	serviceType: input.serviceType ?? src.serviceType
	â—¦	source: src.source ?? "POS"
	â—¦	tableId: input.tableId ?? src.tableId ?? null
	â—¦	note: input.note ?? null
	â—¦	covers: input.covers ?? src.covers ?? null
	â—¦	servedByUserId: input.servedByUserId
	â—¦	acceptedAt: new Date()
	â—¦	code: generateOrderCode()
	4	Mueve esos items al nuevo pedido (updateMany ... data: { orderId: newOrder.id })
	5	Recalcula totales en los dos pedidos:
	â—¦	el original (porque le quitaste cosas)
	â—¦	el nuevo (porque le pusiste cosas)
y te regresa:

{ "newOrderId": ..., "code": "..." }
Listo ğŸ‘Œ

CASOS ğŸ’¥
1. Dividir un pedido de mesa en dos mesas
Pedido original: id = 45, DINE_IN, mesa 3Quiero pasar 2 platillos a la mesa 7
Request

{
  "itemIds": [101, 102],
  "tableId": 7
}
QuÃ© pasa:
	â€¢	crea NUEVO pedido:
	â—¦	status: OPEN
	â—¦	serviceType: DINE_IN (copiado)
	â—¦	tableId: 7 (lo que mandaste)
	â—¦	note: null
	â—¦	covers: los del original
	â€¢	mueve los items 101 y 102 ahÃ­
	â€¢	recalcula los dos
Response

{
  "error": null,
  "data": {
    "newOrderId": 120,
    "code": "A-2025-000120"
  },
  "message": "Order split"
}

2. Dividir sin cambiar mesa (solo separar ticket)
Pedido original: mesa 3Solo quiero mandar estos items a â€œotra cuentaâ€ pero misma mesa.

{
  "itemIds": [101, 103]
}
(no mandas mesa)
â†’ el repo hace:
	â€¢	tableId: src.tableId (o sea, la misma 3)

3. Dividir y quitar mesa (p.ej. para cobrar en caja)

{
  "itemIds": [200, 201],
  "tableId": null,
  "note": "Cobro en caja"
}
â†’ nuevo pedido nace sin mesa y con nota â€œCobro en cajaâ€.

4. Dividir y cambiar serviceType (de DINE_IN a TAKEAWAY)
Esto es Ãºtil cuando alguien de la mesa dice â€œese es para llevarâ€.

{
  "itemIds": [300],
  "serviceType": "TAKEAWAY",
  "note": "Para llevar"
}
â†’ nuevo pedido:
	â€¢	serviceType = TAKEAWAY
	â€¢	tableId = null (porque no mandaste y TAKEAWAY no ocupa)
	â€¢	note = â€œPara llevarâ€

5. Dividir un combo padre (manda SOLO el padre)
SupÃ³n que en el pedido hay un combo con itemId 400.

{
  "itemIds": [400]
}
El repo ve que 400 tiene hijos â†’ busca a todos sus hijos â†’ los mete tambiÃ©n â†’ se van JUNTOS al nuevo pedido.AsÃ­ no te queda el combo descuadrado.

6. Dividir un hijo de combo (manda SOLO el hijo)
SupÃ³n que el papÃ¡ es 400 y el hijo que quieres mover es 402.

{
  "itemIds": [402]
}
El repo hace EXACTAMENTE esto:
	1	â€œAh, este es hijoâ€
	2	trae a su padre
	3	trae a sus hermanos
	4	mete a TODOS juntos en el nuevo pedido
Resultado: nunca te quedas con un combo â€œpartidoâ€.

7. Dividir y poner covers distintos

{
  "itemIds": [501, 502],
  "covers": 1
}
â†’ nuevo pedido con covers = 1â†’ pedido origen se queda con sus covers originales.

8. Dividir con nota especÃ­fica (para cocina / caja)

{
  "itemIds": [601],
  "note": "Cliente paga por separado"
}

9. Intentar dividir sin items â†’ ERROR

{
  "itemIds": []
}
Respuesta:

{
  "error": {
    "code": 400,
    "details": "itemIds must contain at least 1 element(s)"
  },
  "data": null,
  "message": "Error splitting order"
}
(esto viene del Zod porque pusiste .min(1))

10. Intentar dividir items de 2 pedidos diferentes â†’ ERROR
SupÃ³n que mandas [101, 9999] y 9999 es de otro pedido.

{
  "itemIds": [101, 9999]
}
Respuesta (del repo):

{
  "error": {
    "code": 500,
    "details": "Todos los items deben pertenecer al mismo pedido"
  },
  "data": null,
  "message": "Error splitting order"
}

11. Intentar dividir con usuario no autenticado â†’ 401
(no tiene req.auth.userId)

{
  "itemIds": [101]
}
Respuesta:

{
  "error": {
    "code": 401,
    "details": null
  },
  "data": null,
  "message": "Unauthorized"
}
Porque el controller hace:

if (!servedByUserId) return fail(res, "Unauthorized", 401);

12. Dividir y mandar serviceType + tableId juntos

{
  "itemIds": [710, 711],
  "serviceType": "DINE_IN",
  "tableId": 12,
  "note": "Se cambiaron de mesa"
}
â†’ vÃ¡lido; el nuevo pedido nace como DINE_IN en mesa 12.

13. Pedido origen no existe â†’ ERROR
Si el :id no existe:
Request

POST /api/orders/99999/split
Body

{ "itemIds": [1] }
Response (del repo):

{
  "error": {
    "code": 500,
    "details": "Pedido origen no existe"
  },
  "data": null,
  "message": "Error splitting order"
}

Cosas que tu front TIENE que saber
	1	Este endpoint NO regresa el pedido nuevo completo, solo:{ "newOrderId": ..., "code": "..." }
	2	â†’ si lo quieres completo haces luego:GET /api/orders/{{newOrderId}}
	3	
	4	Siempre recalcula los dos pedidos. O sea: en la pantalla de la mesa original te va a bajar el total.
	5	Nunca te deja combos â€œrotosâ€: si mandas papÃ¡ o hijo, mueve el combo entero (padre + hijos + hermanos).
	6	Puedes usarlo para â€œpagar por separadoâ€: divides, pagas el nuevo, dejas el viejo abierto.
	7	Se guarda quiÃ©n hizo el split (servedByUserId), lo cual estÃ¡ chido para auditorÃ­a.

10. Notas funcionales clave
	â€¢	Los totales siempre se recalculan ignorando Ã­tems cancelados.
	â€¢	Se respetan descuentos / impuestos / service fee ya guardados.
	â€¢	prepEtaMinutes sirve para mostrar ETA en front / kiosko.
	â€¢	source y externalRef diferencian interno vs plataforma.
	â€¢	Con esto el front puede hacer todo el flujo:
	0.	creaciÃ³n
	0.	agregar / editar Ã­tems
	0.	KDS
	0.	cobros
	0.	cierre
	0.	listado con filtros

11. Glosario para el front
Permisos
	â€¢	orders.read: puede listar y ver
	â€¢	orders.create: puede crear
	â€¢	orders.update: puede editar, pagar, mover estado
serviceType (tipo de servicio)
	â€¢	DINE_IN: consumo en mesa
	â€¢	TAKEAWAY: para llevar
	â€¢	DELIVERY: a domicilio
source (canal)
	â€¢	POS: pedido directo
	â€¢	UBER, DIDI, RAPPI: plataformas externas
status del pedido
	â€¢	DRAFT: borrador, no cocina
	â€¢	OPEN: activo
	â€¢	HOLD: en pausa
	â€¢	CLOSED: cobrado y cerrado
	â€¢	CANCELED: cancelado
OrderItem.status
	â€¢	NEW
	â€¢	IN_PROGRESS
	â€¢	READY
	â€¢	SERVED
	â€¢	CANCELED
Timestamps
	â€¢	acceptedAt: el pedido saliÃ³ de borrador / cocina lo tomÃ³
	â€¢	readyAt: todos los Ã­tems estÃ¡n listos
	â€¢	servedAt: todos servidos o cancelados
	â€¢	closedAt: se cobrÃ³
	â€¢	canceledAt: se cancelÃ³
Totales (centavos)
	â€¢	subtotalCents: suma de renglones
	â€¢	discountCents: descuentos
	â€¢	serviceFeeCents: propina/fee fijo
	â€¢	taxCents: impuestos
	â€¢	totalCents: subtotal - descuento + service + tax
	â€¢	paymentsTotalCents: suma de pagos
	â€¢	paymentsTipCents: suma de propinas
Pagos (payments[])
	â€¢	method: CASH | CARD | TRANSFER | OTHER
	â€¢	amountCents
	â€¢	tipCents
	â€¢	paidAt
	â€¢	note
Mesa
	â€¢	tableId: id de la mesa
	â€¢	table: { id, name } para mostrar â€œMesa 12â€
	â€¢	covers: nÃºmero de comensales
DTOs clave
	â€¢	ListOrdersQueryDto: filtros del GET
	â€¢	UpdateOrderMetaDto: para editar nota, mesa, cubiertos, ETA
	â€¢	UpdateOrderStatusDto: para mover el pedido validando pagos

Si quieres, en la siguiente te lo bajo todavÃ­a mÃ¡s a â€œdoc para frontâ€ (solo campos + ejemplo), pero asÃ­ ya estÃ¡ ordenado y sin que se vea todo pegado.
